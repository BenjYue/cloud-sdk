"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[6877],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>u});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=i.createContext({}),s=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return i.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),m=s(n),u=a,h=m["".concat(l,".").concat(u)]||m[u]||d[u]||r;return n?i.createElement(h,o(o({ref:t},c),{},{components:n})):i.createElement(h,o({ref:t},c))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=m;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var s=2;s<r;s++)o[s]=n[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},55791:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>p,toc:()=>s});var i=n(87462),a=(n(67294),n(3905));const r={id:"service-bindings",title:"Connecting To Bound Services",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Bound Services",description:"This article explains how the SAP Cloud SDK can be used to connect to services that are bound to the application.",keywords:["sap","cloud","sdk","destination","servicebinding","servicebindingdestinationloader","java","connectivity","btp"]},o=void 0,p={unversionedId:"features/connectivity/service-bindings",id:"features/connectivity/service-bindings",title:"Connecting To Bound Services",description:"This article explains how the SAP Cloud SDK can be used to connect to services that are bound to the application.",source:"@site/docs-java/features/connectivity/003-service-bindings.mdx",sourceDirName:"features/connectivity",slug:"/features/connectivity/service-bindings",permalink:"/cloud-sdk/docs/java/features/connectivity/service-bindings",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-java/features/connectivity/003-service-bindings.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"service-bindings",title:"Connecting To Bound Services",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Bound Services",description:"This article explains how the SAP Cloud SDK can be used to connect to services that are bound to the application.",keywords:["sap","cloud","sdk","destination","servicebinding","servicebindingdestinationloader","java","connectivity","btp"]},sidebar:"docsJavaSidebar",previous:{title:"On-Premise",permalink:"/cloud-sdk/docs/java/features/connectivity/on-premise"},next:{title:"HTTP Destinations",permalink:"/cloud-sdk/docs/java/features/connectivity/http-destinations"}},l={},s=[{value:"Out Of The Box Support",id:"out-of-the-box-support",level:2},{value:"Multitenancy",id:"multitenancy",level:3},{value:"How It Works",id:"how-it-works",level:2},{value:"About the <em>Options</em>",id:"about-the-options",level:2},{value:"Custom Parameters",id:"custom-parameters",level:3},{value:"About the <em>OAuth2Loader</em>",id:"about-the-oauth2loader",level:2},{value:"Dealing With Arbitrary Service Bindings",id:"dealing-with-arbitrary-service-bindings",level:3},{value:"Customization",id:"customization",level:3},{value:"About the Chain Implementation",id:"about-the-chain-implementation",level:2},{value:"Custom Chain Instances",id:"custom-chain-instances",level:3}],c={toc:s};function d(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/SAP/btp-environment-variable-access/wiki/Fundamentals#service-binding"},(0,a.kt)("em",{parentName:"a"},"Service Bindings"))," are a fundamental concept of application deployment on the SAP Business Technology Platform.\nA ",(0,a.kt)("em",{parentName:"p"},"Service Binding"),", in essence, is a set of configurations that applications can use to establish a connection to a (remote) service.\nAs such, both ",(0,a.kt)("em",{parentName:"p"},"Service Bindings")," as well as ",(0,a.kt)("a",{parentName:"p",href:"destination-service#accessing-destinations"},(0,a.kt)("em",{parentName:"a"},"Destination"))," resemble the same concept."),(0,a.kt)("p",null,"The SAP Cloud SDK, therefore, provides a way to convert ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/SAP/btp-environment-variable-access/blob/main/api-parent/core-api/src/main/java/com/sap/cloud/environment/servicebinding/api/ServiceBinding.java"},(0,a.kt)("inlineCode",{parentName:"a"},"ServiceBinding"))," instances into ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," instances. ",(0,a.kt)("br",null),"\nThe code below, for example, demonstrates how to transform a ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," for the ",(0,a.kt)("a",{parentName:"p",href:"https://api.sap.com/api/SAP_CP_Workflow_CF/overview"},"Workflow REST API")," into an ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"import com.sap.cloud.environment.servicebinding.api.ServiceIdentifier;\nimport com.sap.cloud.sdk.cloudplatform.connectivity.BtpServiceOptions;\n\nvar options =\n    ServiceBindingDestinationOptions\n        .forService(ServiceIdentifier.WORKFLOW)\n        .withOption(BtpServiceOptions.WorkflowOptions.REST_API)\n        .build();\nHttpDestination destination = ServiceBindingDestinationLoader.defaultLoaderChain().getDestination(options);\n")),(0,a.kt)("h2",{id:"out-of-the-box-support"},"Out Of The Box Support"),(0,a.kt)("admonition",{title:"Prerequisites",type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"For the following to work, the application needs to add the ",(0,a.kt)("a",{parentName:"p",href:"https://central.sonatype.com/artifact/com.sap.cloud.sdk.cloudplatform/connectivity-oauth"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"connectivity-oauth")," artifact"))," to its dependencies.")),(0,a.kt)("p",null,"The SAP Cloud SDK is able to deal with ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),"s for the following BTP services:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/api/SAP_CP_CF_Connectivity_Destination/overview"},"The BTP Destination Service on Cloud Foundry")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://help.sap.com/docs/connectivity/sap-btp-connectivity-cf/what-is-sap-btp-connectivity"},"The BTP Connectivity Service on Cloud Foundry")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/package/SAPCPWorkflowAPIs/all"},"The SAP Workflow Service on Cloud Foundry"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/api/SAP_CP_Workflow_TCM_CF/overview"},"Inbox API (OData)")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/api/SAP_CP_Workflow_CF/overview"},"Workflow API (REST)")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/package/SAPCPBusinessRulesAPIs/all"},"The SAP Business Rules Service on Cloud Foundry"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/api/SAP_CF_BusinessRules_Repository/overview"},"Rule Authoring API")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://api.sap.com/api/SAP_CF_BusinessRules_Runtime_V2/overview"},"Rule Execution API (v2)")))),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("em",{parentName:"li"},"SAP Business Logging on Cloud Foundry")," (SAP internal)",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Configuration API"),(0,a.kt)("li",{parentName:"ul"},"Text API"),(0,a.kt)("li",{parentName:"ul"},"Reading API"),(0,a.kt)("li",{parentName:"ul"},"Writing API")))),(0,a.kt)("p",null,"For BTP services that offer different APIs (such as the Workflow service), make sure to define which API the converted ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," should point to using the corresponding ",(0,a.kt)("inlineCode",{parentName:"p"},"BtpServiceOptions"),". ",(0,a.kt)("br",null),"\nFor example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"import com.sap.cloud.sdk.cloudplatform.connectivity.BtpServiceOptions;\n\nServiceBindingDestinationOptions\n        .forService(ServiceIdentifier.WORKFLOW)\n        .withOption(BtpServiceOptions.WorkflowOptions.REST_API)\n        .build();\n")),(0,a.kt)("h3",{id:"multitenancy"},"Multitenancy"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," instances created by the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," API are, by default, ",(0,a.kt)("strong",{parentName:"p"},"tenant-aware"),".\nThis means that communication with the target system will happen according to the specified ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.Builder.html#onBehalfOf(com.sap.cloud.sdk.cloudplatform.connectivity.OnBehalfOf)"},(0,a.kt)("inlineCode",{parentName:"a"},"OnBehalfOf")),"."),(0,a.kt)("p",null,"The default value, ",(0,a.kt)("inlineCode",{parentName:"p"},"OnBehalfOf.TECHNICAL_USER_CURRENT_TENANT"),", can be overwritten when assembling the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationOptions")," instance:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:"{4}","{4}":!0},"ServiceBindingDestinationOptions\n    .forService(ServiceIdentifier.WORKFLOW)\n    .withOption(BtpServiceOptions.WorkflowOptions.REST_API)\n    .onBehalfOf(OnBehalfOf.NAMED_USER_CURRENT_TENANT)\n    .build();\n")),(0,a.kt)("h2",{id:"how-it-works"},"How It Works"),(0,a.kt)("p",null,"In general, the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationLoader.html"},(0,a.kt)("inlineCode",{parentName:"a"},"ServiceBindingDestinationLoader")," API")," can be used to convert ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," instances into ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," instances.\nIt comes as part of the ",(0,a.kt)("a",{parentName:"p",href:"https://central.sonatype.com/artifact/com.sap.cloud.sdk.cloudplatform/cloudplatform-connectivity"},(0,a.kt)("inlineCode",{parentName:"a"},"cloudplatform-connectivity")," artifact"),"."),(0,a.kt)("p",null,"The API is designed for easy extensibility and customization.\nHereby, each ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader"),' implementation is supposed to provide the transformation logic for one specific "type" of ',(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),". ",(0,a.kt)("br",null),"\nThe SAP Cloud SDK provides, for example, ",(0,a.kt)("a",{parentName:"p",href:"#about-the-oauth2loader"},"an implementation that is capable of dealing with service bindings that use OAuth2 authentication"),"."),(0,a.kt)("p",null,"As an input, the API requires ",(0,a.kt)("a",{parentName:"p",href:"#about-the-options"},"the ",(0,a.kt)("inlineCode",{parentName:"a"},"ServiceBindingDestinationOptions"))," instance.\nThis class is designed to hold all information that is required to transform a ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," into an ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," - this, first and foremost, includes the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," itself."),(0,a.kt)("p",null,"Furthermore, there is also a ",(0,a.kt)("a",{parentName:"p",href:"#about-the-chain-implementation"},(0,a.kt)("em",{parentName:"a"},"chain")," implementation")," that can be used to combine multiple ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementations into one.\nThe chain will try to load a destination using the given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," delegates until the first of them succeeds - much like a fallback mechanism.\nThis concept is also reflected in the example from above, where the ",(0,a.kt)("inlineCode",{parentName:"p"},"defaultLoaderChain")," is used to load a destination."),(0,a.kt)("h2",{id:"about-the-options"},"About the ",(0,a.kt)("em",{parentName:"h2"},"Options")),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.html"},(0,a.kt)("inlineCode",{parentName:"a"},"ServiceBindingDestinationOptions"))," is an ",(0,a.kt)("strong",{parentName:"p"},"extensible and type-safe")," collection of parameters that can be used to configure the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," transformation process.\nHereby, the least information that is needed is the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," itself, which can be provided using the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.html#forService(com.sap.cloud.environment.servicebinding.api.ServiceBinding)"},(0,a.kt)("inlineCode",{parentName:"a"},"forService(ServiceBinding)"))," method."),(0,a.kt)("p",null,"Alternatively, you can also use ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.html#forService(com.sap.cloud.environment.servicebinding.api.ServiceIdentifier)"},(0,a.kt)("inlineCode",{parentName:"a"},"forService(ServiceIdentifier)")),".\nThis method will try to find a ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," for the given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceIdentifier")," using the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/SAP/btp-environment-variable-access/blob/main/api-parent/access-api/src/main/java/com/sap/cloud/environment/servicebinding/api/DefaultServiceBindingAccessor.java"},(0,a.kt)("inlineCode",{parentName:"a"},"DefaultServiceBindingAccessor")," instance"),". ",(0,a.kt)("br",null),"\n",(0,a.kt)("strong",{parentName:"p"},"Please note:")," If there are multiple or no ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),"s for the given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceIdentifier"),", an exception will be thrown."),(0,a.kt)("p",null,"Besides the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),", there is a second parameter that is shared between all ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementations: The ",(0,a.kt)("inlineCode",{parentName:"p"},"OnBehalfOf"),", for which the destination should be loaded.\nThis can be set using the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.Builder.html#onBehalfOf(com.sap.cloud.sdk.cloudplatform.connectivity.OnBehalfOf)"},(0,a.kt)("inlineCode",{parentName:"a"},"onBehalfOf(OnBehalfOf)"))," method. ",(0,a.kt)("br",null),"\nIf not explicitly specified, ",(0,a.kt)("inlineCode",{parentName:"p"},"OnBehalfOf.TECHNICAL_USER_CURRENT_TENANT")," is used."),(0,a.kt)("h3",{id:"custom-parameters"},"Custom Parameters"),(0,a.kt)("p",null,"Adding custom parameters to the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationOptions")," can be done using the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.Builder.html#withOption(com.sap.cloud.sdk.cloudplatform.connectivity.ServiceBindingDestinationOptions.OptionsEnhancer)"},(0,a.kt)("inlineCode",{parentName:"a"},"withOption(OptionsEnhancer)"))," method.\nHereby, an ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/ServiceBindingDestinationOptions.OptionsEnhancer.html"},(0,a.kt)("inlineCode",{parentName:"a"},"OptionsEnhancer"))," is a type-safe representation of arbitrary parameters."),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Example: Custom Service Binding Transformation"),(0,a.kt)("admonition",{title:"Advanced Usage",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"The following example demonstrates a very advanced usage of our ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," API."),(0,a.kt)("p",{parentName:"admonition"},"A vast majority of use cases do not require a custom ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementation. ",(0,a.kt)("br",null),"\nInstead, customizing the existing ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader")," as ",(0,a.kt)("a",{parentName:"p",href:"#customization"},"described below")," is most probably sufficient.")),(0,a.kt)("p",null,"Lets assume we are providing a custom ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementation that requires some additional information to be able to transform a ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," into an ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination"),"."),(0,a.kt)("p",null,"In this example, we assume that there are two different APIs for our service.\nDepending on which API we want to create our ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," for, we need to slightly alter the transformation logic.\nAdditionally, we want to be able to supply an additional ",(0,a.kt)("inlineCode",{parentName:"p"},"String")," parameter that also affects the created ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination"),"."),(0,a.kt)("p",null,"To achieve this behavior, we would need to implement two ",(0,a.kt)("inlineCode",{parentName:"p"},"OptionsEnhancer"),"s like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyApiChoice.java" showLineNumbers',title:'"MyApiChoice.java"',showLineNumbers:!0},"enum MyApiChoice implements ServiceBindingDestinationOptions.OptionsEnhancer<MyApiChoice> {\n    API1,\n    API2;\n\n    @Nonnull\n    @Override\n    public MyApiChoice getValue() {\n        return this;\n    }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyStringParameter.java" showLineNumbers',title:'"MyStringParameter.java"',showLineNumbers:!0},"class MyStringParameter implements ServiceBindingDestinationOptions.OptionsEnhancer<String> {\n    private final String value;\n\n    public static MyStringParameter of(String value) {\n        return new MyStringParameter(value);\n    }\n\n    private MyStringParameter(String value) {\n        this.value = value;\n    }\n\n    @Nonnull\n    @Override\n    public String getValue() {\n        return value;\n    }\n}\n")),(0,a.kt)("p",null,"The first implementation uses an ",(0,a.kt)("inlineCode",{parentName:"p"},"enum")," to implement a ",(0,a.kt)("strong",{parentName:"p"},"fixed set of choices")," option.\nIt is noteworthy that the actual parameter type is the ",(0,a.kt)("inlineCode",{parentName:"p"},"MyApiChoice")," enum itself.\nThat way, we will be able to retrieve the set value later on."),(0,a.kt)("p",null,"In contrast to that, the second implementation provides a ",(0,a.kt)("inlineCode",{parentName:"p"},"String")," parameter."),(0,a.kt)("p",null,"Setting the options can then be done like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'ServiceBinding someServiceBinding;\n\nServiceBindingDestinationOptions\n        .forService(someServiceBinding)\n        .withOption(MyApiChoice.API1)\n        .withOption(MyStringParameter.of("some-value"))\n        .build();\n')),(0,a.kt)("p",null,"Finally, we can implement our custom ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," that uses our new options like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyCustomServiceBindingLoader.java" showLineNumbers',title:'"MyCustomServiceBindingLoader.java"',showLineNumbers:!0},'class MyCustomServiceBindingLoader implements ServiceBindingDestinationLoader\n{\n    @Nonnull\n    @Override\n    public Try<HttpDestination> tryGetDestination( @Nonnull ServiceBindingDestinationOptions options )\n    {\n        Option<MyApiChoice> maybeOption = options.getOption(MyApiChoice.class);\n        if( maybeOption.isEmpty() ) {\n            return Try.failure(new DestinationNotFoundException("No API choice was specified."));\n        }\n\n        Option<String> maybeStringValue = options.getOption(MyStringParameter.class);\n\n        MyApiChoice option = maybeOption.get();\n        switch( option ) {\n            case API1:\n                // do something\n                break;\n            case API2:\n                // do something else\n                break;\n        }\n    }\n}\n'))),(0,a.kt)("h2",{id:"about-the-oauth2loader"},"About the ",(0,a.kt)("em",{parentName:"h2"},"OAuth2Loader")),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/OAuth2ServiceBindingDestinationLoader.html"},(0,a.kt)("inlineCode",{parentName:"a"},"OAuth2ServiceBindingDestinationLoader"))," comes as part of the ",(0,a.kt)("a",{parentName:"p",href:"https://central.sonatype.com/artifact/com.sap.cloud.sdk.cloudplatform/connectivity-oauth"},(0,a.kt)("inlineCode",{parentName:"a"},"connectivity-oauth")," artifact")," and provides a customizable implementation for converting ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),"s that use OAuth2 authentication into ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," instances. ",(0,a.kt)("br",null),"\nMore precisely, it supports the ",(0,a.kt)("strong",{parentName:"p"},"OAuth2 Client Credentials")," and ",(0,a.kt)("strong",{parentName:"p"},"OAuth2 Client Certificate")," grant types."),(0,a.kt)("p",null,"Internally, the implementation performs the following steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Check whether the given ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBindingDestinationOptions")," can be transformed (e.g. whether the ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBinding")," uses a supported grant type)."),(0,a.kt)("li",{parentName:"ol"},"Extract the required information from the ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBinding")," (i.e. the service URL, the token URL, and the client identity)."),(0,a.kt)("li",{parentName:"ol"},"Assemble an ",(0,a.kt)("inlineCode",{parentName:"li"},"HttpDestination")," that uses the extracted information for the ",(0,a.kt)("strong",{parentName:"li"},"target authentication")," (i.e. HTTP header ",(0,a.kt)("inlineCode",{parentName:"li"},"Authorization"),").")),(0,a.kt)("h3",{id:"dealing-with-arbitrary-service-bindings"},"Dealing With Arbitrary Service Bindings"),(0,a.kt)("p",null,"Even though ",(0,a.kt)("strong",{parentName:"p"},"service bindings")," are a fundamental concept in the SAP Business Technology Platform, the way they are used and structured can ",(0,a.kt)("strong",{parentName:"p"},"vary greatly from service to service"),".\nAs a consequence, it is not possible to provide a uniform way of dealing with arbitrary ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding"),"s. ",(0,a.kt)("br",null),"\nTherefore, the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader")," leverages the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/OAuth2PropertySupplier.html"},(0,a.kt)("inlineCode",{parentName:"a"},"OAuth2PropertySupplier"))," interface to extract the required information from a given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoaderOptions")," instance."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader")," stores a ",(0,a.kt)("strong",{parentName:"p"},"static list")," of ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," instances.\nWhenever the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader")," is asked to load a destination, it will iterate over this list (",(0,a.kt)("strong",{parentName:"p"},"in order"),") to see whether"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"the given ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBindingDestinationOptions")," can be transformed into an ",(0,a.kt)("inlineCode",{parentName:"li"},"HttpDestination")," using the current ",(0,a.kt)("inlineCode",{parentName:"li"},"OAuth2PropertySupplier")," instance, and, if so"),(0,a.kt)("li",{parentName:"ol"},"extract the required information from the given ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBindingDestinationOptions")," using the current ",(0,a.kt)("inlineCode",{parentName:"li"},"OAuth2PropertySupplier"),".")),(0,a.kt)("p",null,"By default, there are ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," for the services ",(0,a.kt)("a",{parentName:"p",href:"#out-of-the-box-support"},"mentioned above")," in place."),(0,a.kt)("h3",{id:"customization"},"Customization"),(0,a.kt)("p",null,"In case the default configuration of the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader")," does not fit your needs, you can customize it by adding your own ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," instances to the static list of the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"OAuth2ServiceBindingDestinationLoader.registerPropertySupplier(this::canBeConverted, this::propertySupplierFactory);\n\nboolean canBeConverted(ServiceBindingDestinationOptions options);\nOAuth2PropertySupplier propertySupplierFactory(ServiceBindingDestinationOptions options);\n")),(0,a.kt)("p",null,"As shown above, the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/OAuth2ServiceBindingDestinationLoader.html#registerPropertySupplier(java.util.function.Predicate,java.util.function.Function)"},(0,a.kt)("inlineCode",{parentName:"a"},"registerPropertySupplier"))," method takes two methods as parameters.\nThis might be unintuitive, but is needed to allow for efficient implementations."),(0,a.kt)("p",null,"What is happening internally when this method is used, is that the given parameters are transformed into an internal representation, which is then ",(0,a.kt)("strong",{parentName:"p"},"prepended")," to the list of available ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," instances.\nIn other words: Using the ",(0,a.kt)("inlineCode",{parentName:"p"},"registerPropertySupplier")," method will make your ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," instance be considered ",(0,a.kt)("strong",{parentName:"p"},"before")," any previously registered ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," instance, including the default ones."),(0,a.kt)("details",null,(0,a.kt)("summary",null,"Full Example"),(0,a.kt)("p",null,"To make things a bit more concrete, let's assume we wanted to implement support for an other service, which uses its very own ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," structure."),(0,a.kt)("p",null,"Our hypothetical service binding could look like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"showLineNumbers",showLineNumbers:!0},'{\n  "service": "my-service",\n  "credentials": {\n    "service": {\n      "read": "https://my-service.com/api/v1/read",\n      "write": "https://my-service.com/api/v2/write"\n    },\n    "oauth": {\n      "uri": "https://my-service.com/oauth/token",\n      "id": "my-client-id",\n      "secret": "my-client-secret"\n    }\n  }\n}\n')),(0,a.kt)("p",null,"The service binding above contains two different API endpoints (",(0,a.kt)("inlineCode",{parentName:"p"},"read")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"write"),"), which we would like to be able to access using the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader"),".\nTo support that, we need to implement an ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," (to implement the property extraction logic) and an ",(0,a.kt)("inlineCode",{parentName:"p"},"OptionsEnhancer")," (to allow users to define which endpoint they would like to use):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyApiEndpoint.java" showLineNumbers',title:'"MyApiEndpoint.java"',showLineNumbers:!0},"enum MyApiEndpoint implements ServiceBindingDestinationOptions.OptionsEnhancer<MyApiEndpoint> {\n    READ,\n    WRITE;\n\n    @Nonnull\n    @Override\n    public MyApiEndpoint getValue() {\n        return this;\n    }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyServiceOAuth2PropertySupplier.java" showLineNumbers',title:'"MyServiceOAuth2PropertySupplier.java"',showLineNumbers:!0},'class MyServiceOAuth2PropertySupplier extends DefaultOAuth2PropertySupplier\n{\n    public MyServiceOAuth2PropertySupplier(ServiceBindingDestinationOptions options) {\n        super(options, Collections.singletonList("oauth"));\n    }\n\n    @Override\n    public boolean isOAuth2Binding() {\n        return getOAuthCredential(String.class, "id").isDefined();\n    }\n\n    @Nonnull\n    @Override\n    public URI getServiceUri() {\n        MyApiEndpoint endpoint = options.getOption(MyApiEndpoint.class).getOrElse(MyApiEndpoint.READ);\n        return switch (endpoint) {\n            case READ -> getCredentialOrThrow(URI.class, "service", "read");\n            case WRITE -> getCredentialOrThrow(URI.class, "service", "write");\n        };\n    }\n\n    @Nonnull\n    @Override\n    public URI getTokenUri() {\n        return getOAuthCredentialOrThrow(URI.class, "uri");\n    }\n\n    @Nonnull\n    @Override\n    public ClientIdentity getClientIdentity() {\n        var clientId = getOAuthCredentialOrThrow(String.class, "id");\n        var clientSecret = getOAuthCredentialOrThrow(String.class, "secret");\n        return new ClientCredentials(clientId, clientSecret);\n    }\n}\n')),(0,a.kt)("p",null,"Lets examine the implementation above:"),(0,a.kt)("p",null,"Right in the first line, you can see that our implementation extends the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/DefaultOAuth2PropertySupplier.html"},(0,a.kt)("inlineCode",{parentName:"a"},"DefaultOAuth2PropertySupplier"))," class, instead of implementing the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," interface directly. ",(0,a.kt)("br",null),"\nThis is because the ",(0,a.kt)("inlineCode",{parentName:"p"},"DefaultOAuth2PropertySupplier")," class provides a lot of useful functionality, which we can reuse in our implementation. ",(0,a.kt)("br",null),"\nWe will see that in a second."),(0,a.kt)("p",null,"Next thing we should pay attention to is the constructor of our class. ",(0,a.kt)("br",null),"\nIt takes an instance of ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationOptions")," as a parameter.\nThis instance is then passed to the ",(0,a.kt)("inlineCode",{parentName:"p"},"super")," constructor (line 4) along with a list of ",(0,a.kt)("inlineCode",{parentName:"p"},"String"),"s."),(0,a.kt)("p",null,"The super class (",(0,a.kt)("inlineCode",{parentName:"p"},"DefaultOAuth2PropertySupplier"),") uses these parameters to"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"cache the ",(0,a.kt)("em",{parentName:"li"},"credentials")," portion of the ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBinding")," (given in the ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBindingDestinationOptions"),") as a ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/SAP/btp-environment-variable-access/blob/main/api-parent/consumption-api/src/main/java/com/sap/cloud/environment/servicebinding/api/TypedMapView.java"},(0,a.kt)("inlineCode",{parentName:"a"},"TypedMapView")," instance")," and"),(0,a.kt)("li",{parentName:"ol"},"set the ",(0,a.kt)("em",{parentName:"li"},"default oauth2 properties path")," ",(0,a.kt)("strong",{parentName:"li"},"within")," the ",(0,a.kt)("em",{parentName:"li"},"credentials")," portion of the ",(0,a.kt)("inlineCode",{parentName:"li"},"ServiceBinding"),".")),(0,a.kt)("p",null,"Converting the ",(0,a.kt)("em",{parentName:"p"},"credentials")," portion of the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBinding")," into a ",(0,a.kt)("inlineCode",{parentName:"p"},"TypedMapView")," is helpful for parsing the nested structure. ",(0,a.kt)("br",null),"\nTherefore, it is a good idea to do the conversion (i.e. ",(0,a.kt)("inlineCode",{parentName:"p"},"TypeMapView.ofCredentials(ServiceBinding)"),") just once as it performs an expensive deep-copy.\nHereby, the ",(0,a.kt)("inlineCode",{parentName:"p"},"DefaultOAuth2PropertySupplier")," takes care of doing the conversion upon initialization and caching the result for later use."),(0,a.kt)("p",null,"Further down in our code (i.e. within the overriden methods), we can then use the ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/DefaultOAuth2PropertySupplier.html#getCredential(java.lang.Class,java.lang.String...)"},(0,a.kt)("inlineCode",{parentName:"a"},"getCredential/OrThrow"))," and ",(0,a.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/connectivity/DefaultOAuth2PropertySupplier.html#getOAuthCredential(java.lang.Class,java.lang.String...)"},(0,a.kt)("inlineCode",{parentName:"a"},"getOAuthCredential/OrThrow"))," methods to extract the required information from the cached ",(0,a.kt)("em",{parentName:"p"},"credentials"),". ",(0,a.kt)("br",null),"\nThe main difference between ",(0,a.kt)("inlineCode",{parentName:"p"},"getCredential")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"getOAuthCredential")," is that the latter will ",(0,a.kt)("strong",{parentName:"p"},"prepend")," the ",(0,a.kt)("em",{parentName:"p"},"default oauth2 properties path")," to the one given in the method invocation before trying to extract the information. ",(0,a.kt)("br",null),"\nIn our example (line 9), this means that ",(0,a.kt)("inlineCode",{parentName:"p"},'getOAuthCredential(String.class, "id")')," will try to extract a ",(0,a.kt)("inlineCode",{parentName:"p"},"String")," value from ",(0,a.kt)("inlineCode",{parentName:"p"},'credentials.get("oauth").get("id")')," (",(0,a.kt)("em",{parentName:"p"},"pseudo code"),"). ",(0,a.kt)("br",null),"\nIn contrast to that, using just ",(0,a.kt)("inlineCode",{parentName:"p"},'getCredential(String.class, "id")')," would try to extract a ",(0,a.kt)("inlineCode",{parentName:"p"},"String")," value from ",(0,a.kt)("inlineCode",{parentName:"p"},'credentials.get("id")')," (",(0,a.kt)("em",{parentName:"p"},"pseudo code"),"). ",(0,a.kt)("br",null),"\n",(0,a.kt)("inlineCode",{parentName:"p"},"getOAuthCredential")," is therefore just a neat shortcut that can help to reduce repetitive code."),(0,a.kt)("p",null,"Please note how we are handling our ",(0,a.kt)("inlineCode",{parentName:"p"},"MyApiEndpoint")," option in the ",(0,a.kt)("inlineCode",{parentName:"p"},"getServiceUri")," method (lines 14 - 20). ",(0,a.kt)("br",null),"\nWe are reading the option by simply providing the ",(0,a.kt)("inlineCode",{parentName:"p"},"MyApiEndpoint.class")," as the parameter to the ",(0,a.kt)("inlineCode",{parentName:"p"},"getOption")," method.\nThat way, we can decide which service URI to use, depending on the user input."),(0,a.kt)("p",null,"Lastly, we need to register our ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," implementation with the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="MyServiceOAuth2PropertySupplier.java" showLineNumbers',title:'"MyServiceOAuth2PropertySupplier.java"',showLineNumbers:!0},'class MyServiceOAuth2PropertySupplier extends DefaultOAuth2PropertySupplier {\n    private static final ServiceIdentifier MY_SERVICE_IDENTIFIER = ServiceIdentifier.of("my-service");\n\n    public static boolean matches(ServiceBindingDestinationOptions options) {\n        var serviceIdentifier = options.getServiceBinding().getServiceIdentifier().orElse(null);\n        return MY_SERVICE_IDENTIFIER.equals(serviceIdentifier);\n    }\n\n    // skipped for brevity\n}\n\nOAuth2ServiceBindingDestinationLoader.registerPropertySupplier(MyServiceOAuth2PropertySupplier::matches, MyServiceOAuth2PropertySupplier::new);\n')),(0,a.kt)("p",null,"In the above example, we added a static ",(0,a.kt)("inlineCode",{parentName:"p"},"matches")," method (lines 4 - 7) to our ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2PropertySupplier")," implementation, which we can use to check whether the given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationOptions")," can be transformed into an ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination")," using our implementation.\nWe are then using method references to register our implementation with the ",(0,a.kt)("inlineCode",{parentName:"p"},"OAuth2ServiceBindingDestinationLoader"),".")),(0,a.kt)("h2",{id:"about-the-chain-implementation"},"About the Chain Implementation"),(0,a.kt)("p",null,"As mentioned ",(0,a.kt)("a",{parentName:"p",href:"#how-it-works"},"above"),", the ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," comes with a private ",(0,a.kt)("em",{parentName:"p"},"chain")," implementation."),(0,a.kt)("p",null,"The default instance of that chain (",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader.defaultLoaderChain"),") is created using the ",(0,a.kt)("em",{parentName:"p"},"Service Locator Pattern")," to find all available ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementations on the classpath.\nInstances of these implementations are then used as delegate loaders.\nWhen transforming a ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationOptions")," into an ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpDestination"),", the chain will invoke the delegates ",(0,a.kt)("strong",{parentName:"p"},"in order")," until the first one either succeeds or throws an exception other than ",(0,a.kt)("inlineCode",{parentName:"p"},"DestinationNotFoundException"),"."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("em",{parentName:"p"},"Service Locator Pattern")," does not provide any guarantees about the order in which implementations on the classpath are found.\nTherefore, it is ",(0,a.kt)("strong",{parentName:"p"},"crucial")," that ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," implementations do ",(0,a.kt)("strong",{parentName:"p"},"not handle the same ",(0,a.kt)("inlineCode",{parentName:"strong"},"ServiceBindingDestinationOptions"))," as otherwise the default chain's behavior would be ",(0,a.kt)("strong",{parentName:"p"},"unpredictable"),"."),(0,a.kt)("p",{parentName:"admonition"},"Implementations provided by the SAP Cloud SDK follow this rule.")),(0,a.kt)("h3",{id:"custom-chain-instances"},"Custom Chain Instances"),(0,a.kt)("p",null,"If the default chain implementation does not meet your needs, you can create your own chain instance:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"ServiceBindingDestinationLoader myChain = ServiceBindingDestinationLoader.newLoaderChain(\n        Arrays.asList(\n                new MyFirstLoader(),\n                new MySecondLoader()\n        ));\n")),(0,a.kt)("p",null,"The code above initializes a new instance of the private chain implementation, which uses the given ",(0,a.kt)("inlineCode",{parentName:"p"},"ServiceBindingDestinationLoader")," instances ",(0,a.kt)("strong",{parentName:"p"},"in the specified order")," as its delegates.\nTherefore, deterministic behavior is guaranteed."))}d.isMDXComponent=!0}}]);