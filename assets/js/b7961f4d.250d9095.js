"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[3145,3478,6331,8739,1877,583],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},74937:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={},i=void 0,s={unversionedId:"environments/code/Dockerfile",id:"environments/code/Dockerfile",title:"Dockerfile",description:"",source:"@site/docs-js/environments/code/Dockerfile.mdx",sourceDirName:"environments/code",slug:"/environments/code/Dockerfile",permalink:"/cloud-sdk/docs/js/environments/code/Dockerfile",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/code/Dockerfile.mdx",tags:[],version:"current",frontMatter:{}},l={},c=[],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-Dockerfile",metastring:'title="Dockerfile"',title:'"Dockerfile"'},'FROM node:14-alpine\n\nWORKDIR /workdir\n\nCOPY /deployment /workdir\n\nRUN ["npm", "install", "--unsafe-perm"]\n\nEXPOSE 3000\nCMD ["npm", "run", "start:prod"]\n')))}u.isMDXComponent=!0},3431:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>c,toc:()=>u});var a=n(87462),r=(n(67294),n(3905)),o=n(74866),i=n(85162);const s={},l=void 0,c={unversionedId:"environments/code/kyma-app-tabs",id:"environments/code/kyma-app-tabs",title:"kyma-app-tabs",description:'<Tabs defaultValue="deployment"',source:"@site/docs-js/environments/code/kyma-app-tabs.mdx",sourceDirName:"environments/code",slug:"/environments/code/kyma-app-tabs",permalink:"/cloud-sdk/docs/js/environments/code/kyma-app-tabs",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/code/kyma-app-tabs.mdx",tags:[],version:"current",frontMatter:{}},p={},u=[],d={toc:u};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(o.Z,{defaultValue:"deployment",values:[{label:"values.yaml",value:"values"},{label:"Chart.yaml",value:"Chart"},{label:"configmap.yaml",value:"configmap"},{label:"deployment.yaml",value:"deployment"},{label:"service.yaml",value:"service"}],mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"values",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"image:\n  repository: <YOUR_REPO>/k8s-e2e-app:latest # replace <YOUR_REPO> with your Docker repository\n  tag: latest\nresources:\n  requests:\n    memory: '256Mi'\n    cpu: '500m'\n  limits:\n    memory: '512Mi'\n    cpu: '1000m'\n"))),(0,r.kt)(i.Z,{value:"Chart",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v2\nname: app-chart\ndescription: A Helm chart for Kubernetes\n\n# A chart can be either an 'application' or a 'library' chart.\n#\n# Application charts are a collection of templates that can be packaged into versioned archives\n# to be deployed.\n#\n# Library charts provide useful utilities or functions for the chart developer. They're included as\n# a dependency of application charts to inject those utilities and functions into the rendering\n# pipeline. Library charts do not define any templates and therefore cannot be deployed.\ntype: application\n\n# This is the chart version. This version number should be incremented each time you make changes\n# to the chart and its templates, including the app version.\n# Versions are expected to follow Semantic Versioning (https://semver.org/)\nversion: 0.1.0\n\n# This is the version number of the application being deployed. This version number should be\n# incremented each time you make changes to the application. Versions are not expected to\n# follow Semantic Versioning. They should reflect the version the application is using.\n# It is recommended to use it with quotes.\nappVersion: '1.0.0'\n"))),(0,r.kt)(i.Z,{value:"configmap",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ include "app-chart.fullname" . }}-config\ndata:\n  cloud_destination: {{ .Values.cloudDestination | quote }}\n  onpremise_destination: {{ .Values.onPremiseDestination | quote }}\n  principal_propagation_destination: {{ .Values.principalPropagationDestination | quote }}\n'))),(0,r.kt)(i.Z,{value:"service",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Service\nmetadata:\n  name: {{ include "app-chart.fullname" . }}-svc\n  labels:\n    {{- include "app-chart.labels" . | nindent 4 }}\nspec:\n  ports:\n    - port: 8080\n      targetPort: 3000\n  selector:\n    {{- include "app-chart.selectorLabels" . | nindent 4 }}\n'))),(0,r.kt)(i.Z,{value:"deployment",className:"code-block-height-js thin-scrollbar",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: {{ include "app-chart.fullname" . }}\n  labels:\n    {{- include "app-chart.labels" . | nindent 4 }}\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      {{- include "app-chart.selectorLabels" . | nindent 6 }}\n  template:\n    metadata:\n      labels:\n        {{- include "app-chart.selectorLabels" . | nindent 8 }}\n    spec:\n      {{- with .Values.imagePullSecrets }}\n      imagePullSecrets:\n        {{- toYaml . | nindent 8 }}\n      {{- end }}\n      serviceAccountName: {{ include "app-chart.serviceAccountName" . }}\n      containers:\n        - name: {{ .Chart.Name }}\n          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"\n          ports:\n            - containerPort: 3000\n          resources:\n            {{- toYaml .Values.resources | nindent 12 }}\n          env:\n            - name: CLOUD_DESTINATION\n              valueFrom:\n                configMapKeyRef:\n                  name: {{ include "app-chart.fullname" . }}-config\n                  key: cloud_destination\n            - name: ONPREMISE_DESTINATION\n              valueFrom:\n                configMapKeyRef:\n                  name: {{ include "app-chart.fullname" . }}-config\n                  key: onpremise_destination\n            - name: PRINCIPAL_PROPAGATION_DESTINATION\n              valueFrom:\n                configMapKeyRef:\n                  name: {{ include "app-chart.fullname" . }}-config\n                  key: principal_propagation_destination\n          volumeMounts:\n            - name: destination-volume\n              mountPath: {{ printf "/etc/secrets/sapcp/destination/%s" .Values.destinationBinding | quote }}\n              readOnly: true\n            - name: xsuaa-volume\n              mountPath: {{ printf "/etc/secrets/sapcp/xsuaa/%s" .Values.xsuaaBinding | quote }}\n              readOnly: true\n            - name: connectivity-volume\n              mountPath: {{ printf "/etc/secrets/sapcp/connectivity/%s" .Values.connectivityBinding | quote }}\n              readOnly: true\n      volumes:\n        - name: destination-volume\n          secret:\n            secretName: {{ .Values.destinationBinding | quote }}\n        - name: xsuaa-volume\n          secret:\n            secretName: {{ .Values.xsuaaBinding | quote }}\n        - name: connectivity-volume\n          secret:\n            secretName: {{ .Values.connectivityBinding | quote }}\n')))))}m.isMDXComponent=!0},42779:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>c,toc:()=>u});var a=n(87462),r=(n(67294),n(3905)),o=n(74866),i=n(85162);const s={},l=void 0,c={unversionedId:"environments/code/kyma-approuter-tabs",id:"environments/code/kyma-approuter-tabs",title:"kyma-approuter-tabs",description:'<Tabs defaultValue="deployment"',source:"@site/docs-js/environments/code/kyma-approuter-tabs.mdx",sourceDirName:"environments/code",slug:"/environments/code/kyma-approuter-tabs",permalink:"/cloud-sdk/docs/js/environments/code/kyma-approuter-tabs",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/code/kyma-approuter-tabs.mdx",tags:[],version:"current",frontMatter:{}},p={},u=[],d={toc:u};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(o.Z,{defaultValue:"deployment",values:[{label:"values.yaml",value:"values"},{label:"Chart.yaml",value:"Chart"},{label:"configmap.yaml",value:"configmap"},{label:"deployment.yaml",value:"deployment"},{label:"service.yaml",value:"service"}],mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"values",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"xsuaaBinding:\n  config:\n    idp:\n    pattern:\n  image:\n    repository: <YOUR_REPO>/k8s-approuter:latest # replace <YOUR_REPO> with your Docker repository\n    tag: latest\n  resources:\n    requests:\n      memory: '256Mi'\n      cpu: '500m'\n    limits:\n      memory: '512Mi'\n      cpu: '1000m'\n"))),(0,r.kt)(i.Z,{value:"Chart",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v2\nname: approuter-chart\ndescription: A Helm chart for Kubernetes\n\n# A chart can be either an 'application' or a 'library' chart.\n#\n# Application charts are a collection of templates that can be packaged into versioned archives\n# to be deployed.\n#\n# Library charts provide useful utilities or functions for the chart developer. They're included as\n# a dependency of application charts to inject those utilities and functions into the rendering\n# pipeline. Library charts do not define any templates and therefore cannot be deployed.\ntype: application\n\n# This is the chart version. This version number should be incremented each time you make changes\n# to the chart and its templates, including the app version.\n# Versions are expected to follow Semantic Versioning (https://semver.org/)\nversion: 0.1.0\n\n# This is the version number of the application being deployed. This version number should be\n# incremented each time you make changes to the application. Versions are not expected to\n# follow Semantic Versioning. They should reflect the version the application is using.\n# It is recommended to use it with quotes.\nappVersion: '1.0.0'\n"))),(0,r.kt)(i.Z,{value:"configmap",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: {{ include "approuter-chart.fullname" . }}-config\ndata:\n  {{- if .Values.config.idp }}\n  xs-app.json: {{ printf "{\\"welcomeFile\\":\\"/web-pages/index.html\\",\\"routes\\":[{\\"source\\":\\"/backend-app/(.*)\\",\\"target\\":\\"$1\\",\\"destination\\":\\"backend\\",\\"identityProvider\\":\\"%s\\"},{\\"source\\":\\"/web-pages/(.*)\\",\\"target\\":\\"$1\\",\\"localDir\\":\\"static-resources\\",\\"identityProvider\\":\\"%s\\"}]}" .Values.config.idp .Values.config.idp | toPrettyJson }}\n  {{- else }}\n  xs-app.json: {{ .Values.config.json | toPrettyJson | quote }}\n  {{ end -}}\n'))),(0,r.kt)(i.Z,{value:"service",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Service\nmetadata:\n  name: {{ include "approuter-chart.fullname" . }}-svc\n  labels:\n    {{- include "approuter-chart.labels" . | nindent 4 }}\nspec:\n  ports:\n    - port: 8080\n      targetPort: 5000\n  selector:\n    {{- include "approuter-chart.selectorLabels" . | nindent 4 }}\n'))),(0,r.kt)(i.Z,{value:"deployment",className:"code-block-height-js thin-scrollbar",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: {{ include "approuter-chart.fullname" . }}\n  labels:\n    {{- include "approuter-chart.labels" . | nindent 4 }}\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      {{- include "approuter-chart.selectorLabels" . | nindent 6 }}\n  template:\n    metadata:\n      labels:\n        {{- include "approuter-chart.selectorLabels" . | nindent 8 }}\n    spec:\n      {{- with .Values.imagePullSecrets }}\n      imagePullSecrets:\n        {{- toYaml . | nindent 8 }}\n      {{- end }}\n      serviceAccountName: {{ include "approuter-chart.serviceAccountName" . }}\n      containers:\n        - name: {{ .Chart.Name }}\n          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"\n          ports:\n            - containerPort: 5000\n          resources:\n            {{- toYaml .Values.resources | nindent 12 }}\n          env:\n            - name: PORT\n              value: "5000"\n            - name: destinations\n              value: \'[{"name":"backend", "url":"http://{{ printf "%s-%s" .Release.Name "app-chart" | trunc 63 | trimSuffix "-" }}-svc:8080/", "forwardAuthToken": true}]\'\n            - name: TENANT_HOST_PATTERN\n              value: {{ .Values.config.pattern | quote }}\n          volumeMounts:\n            - name: xsuaa-volume\n              mountPath: {{ printf "/etc/secrets/sapcp/xsuaa/%s" .Values.xsuaaBinding | quote}}\n              readOnly: true\n            - name: approuter-volume\n              mountPath: "/usr/src/app/xs-app.json"\n              subPath: "xs-app.json"\n              readOnly: true\n      volumes:\n        - name: xsuaa-volume\n          secret:\n            secretName: {{ .Values.xsuaaBinding | quote}}\n        - name: approuter-volume\n          configMap:\n            name: {{ include "approuter-chart.fullname" . }}-config\n            items:\n              - key: xs-app.json\n                path: xs-app.json\n\n\n')))))}m.isMDXComponent=!0},18877:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={},i=void 0,s={unversionedId:"environments/code/operator-destination-service",id:"environments/code/operator-destination-service",title:"operator-destination-service",description:"",source:"@site/docs-js/environments/code/operator-destination-service.mdx",sourceDirName:"environments/code",slug:"/environments/code/operator-destination-service",permalink:"/cloud-sdk/docs/js/environments/code/operator-destination-service",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/code/operator-destination-service.mdx",tags:[],version:"current",frontMatter:{}},l={},c=[],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="operator-destination-service.yml"',title:'"operator-destination-service.yml"'},"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceInstance\nmetadata:\n  name: operator-destination-service\nspec:\n  serviceOfferingName: destination\n  servicePlanName: lite\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="operator-destination-binding.yml"',title:'"operator-destination-binding.yml"'},"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceBinding\nmetadata:\n  name: operator-destination-service\nspec:\n  serviceInstanceName: operator-destination-service\n")))}u.isMDXComponent=!0},18052:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={},i=void 0,s={unversionedId:"environments/code/operator-xsuaa-service",id:"environments/code/operator-xsuaa-service",title:"operator-xsuaa-service",description:"",source:"@site/docs-js/environments/code/operator-xsuaa-service.mdx",sourceDirName:"environments/code",slug:"/environments/code/operator-xsuaa-service",permalink:"/cloud-sdk/docs/js/environments/code/operator-xsuaa-service",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/code/operator-xsuaa-service.mdx",tags:[],version:"current",frontMatter:{}},l={},c=[],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="operator-xsuaa-service.yml"',title:'"operator-xsuaa-service.yml"'},"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceInstance\nmetadata:\n  name: operator-xsuaa-service\nspec:\n  serviceOfferingName: xsuaa\n  servicePlanName: application\n  parameters:\n    xsappname: kubernetes-xsuaa\n    tenant-mode: shared\n    scopes:\n      - name: '$XSAPPNAME.Callback'\n        description: 'With this scope set, the callbacks for tenant onboarding, offboarding and getDependencies can be called.'\n        grant-as-authority-to-apps:\n          - $XSAPPNAME(application,sap-provisioning,tenant-onboarding)\n    role-templates:\n      - name: TOKEN_EXCHANGE\n        description: Token exchange\n        scope-references:\n          - uaa.user\n      - name: 'MultitenancyCallbackRoleTemplate'\n        description: 'Call callback-services of applications'\n        scope-references:\n          - '$XSAPPNAME.Callback'\n    oauth2-configuration:\n      grant-types:\n        - authorization_code\n        - client_credentials\n        - password\n        - refresh_token\n        - urn:ietf:params:oauth:grant-type:saml2-bearer\n        - user_token\n        - client_x509\n        - urn:ietf:params:oauth:grant-type:jwt-bearer\n      # Allowed redirect URIs in case you want to use an approuter behind an ingress for user login\n      redirect-uris:\n        - https://*/**\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="operator-xsuaa-binding.yml"',title:'"operator-xsuaa-binding.yml"'},"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceBinding\nmetadata:\n  name: operator-xsuaa-service\nspec:\n  serviceInstanceName: operator-xsuaa-service\n")))}u.isMDXComponent=!0},90643:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(87462),r=(n(67294),n(3905)),o=n(96386);const i={id:"kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",sidebar_label:"Kubernetes with SAP Gardener",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",keywords:["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","kubernetes"]},s="Migrate a Cloud Foundry Application to a Kubernetes Cluster",l={unversionedId:"environments/kubernetes",id:"environments/kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",source:"@site/docs-js/environments/migrate-sdk-application-from-btp-cf-to-kubernetes.mdx",sourceDirName:"environments",slug:"/environments/kubernetes",permalink:"/cloud-sdk/docs/js/environments/kubernetes",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/environments/migrate-sdk-application-from-btp-cf-to-kubernetes.mdx",tags:[],version:"current",frontMatter:{id:"kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",sidebar_label:"Kubernetes with SAP Gardener",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",keywords:["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","kubernetes"]},sidebar:"docsJsSidebar",previous:{title:"Shared ESLint configuration",permalink:"/cloud-sdk/docs/js/features/eslint-configuration"},next:{title:"Kubernetes with SAP Kyma",permalink:"/cloud-sdk/docs/js/environments/kyma"}},c={},p=[{value:"Prerequisites",id:"prerequisites",level:3},{value:"Create and Bind SAP BTP Services",id:"create-and-bind-sap-btp-services",level:3},{value:"Bind the Destination Service",id:"bind-the-destination-service",level:4},{value:"Bind the XSUAA Service",id:"bind-the-xsuaa-service",level:4},{value:"Deploy to Kubernetes",id:"deploy-to-kubernetes",level:2},{value:"Containerize the Application",id:"containerize-the-application",level:3},{value:"Create a Deployment Configuration",id:"create-a-deployment-configuration",level:3},{value:"Access Your Application",id:"access-your-application",level:3},{value:"Local Connection",id:"local-connection",level:4},{value:"Internet Facing Connection",id:"internet-facing-connection",level:4},{value:"Configure TLS and Obtain a Domain in SAP Gardener",id:"configure-tls-and-obtain-a-domain-in-sap-gardener",level:3},{value:"Expose the Application using Approuter",id:"expose-the-application-using-approuter",level:3},{value:"Principal Propagation",id:"principal-propagation",level:2},{value:"On-Premise Connectivity",id:"on-premise-connectivity",level:2},{value:"Create a Continuous Integration Pipeline",id:"create-a-continuous-integration-pipeline",level:2}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"migrate-a-cloud-foundry-application-to-a-kubernetes-cluster"},"Migrate a Cloud Foundry Application to a Kubernetes Cluster"),(0,r.kt)("p",null,"This guide details the steps necessary to migrate an application from Cloud Foundry to a Gardener-based Kubernetes cluster.\nThe samples repository contains the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/k8s-sample-application"},"Kubernetes application")," that will be used in this guide."),(0,r.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/tools/"},(0,r.kt)("inlineCode",{parentName:"a"},"kubectl")),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/get-docker/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker"))," and ensure access to a publicly reachable Docker repository."),(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"A Kubernetes cluster uses a secret to authenticate with a container registry to pull an image.\nFor that, you will need to ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-secret-by-providing-credentials-on-the-command-line"},"configure a secret in your cluster"),":"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret docker-registry regcred --docker-server=YOUR_DOCKER_SERVER --docker-username=YOUR_DOCKER_USERNAME --docker-password=YOUR_DOCKER_PASSWORD --docker-email=YOUR_DOCKER_EMAIL\n")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Use ",(0,r.kt)("a",{parentName:"p",href:"https://dashboard.garden.canary.k8s.ondemand.com/"},"Gardener")," for a Kubernetes Cluster with a load balancer enabled."),(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"This guide assumes you have created a cluster via Gardener dashboard and have it set up for cluster access.\nWe also recommend to have an ",(0,r.kt)("strong",{parentName:"p"},"Ingress")," set up that exposes the application to the internet."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("a",{parentName:"p",href:"https://helm.sh/docs/intro/install/"},(0,r.kt)("inlineCode",{parentName:"a"},"helm")),", a package manager for Kubernetes.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SAP/sap-btp-service-operator/"},"SAP BTP Service Operator")," in the cluster."),(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"For production environments, you need a reliable way of configuring which services are running in your cluster.\nTo achieve that, leverage the SAP BTP Service Operator.\nThis guide assumes you have the SAP BTP Service Operator installed in your cluster.\nIf not, follow the setup instructions ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SAP/sap-btp-service-operator#setup"},"here"),".")))),(0,r.kt)("h3",{id:"create-and-bind-sap-btp-services"},"Create and Bind SAP BTP Services"),(0,r.kt)("p",null,"Since the service operator is running in your cluster, you can create services just like you would do in SAP BTP CF, but instead of the SAP BTP cockpit, you'll use YAML service definitions.\nFor this guide, we'll assume the application uses two services:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Destination Service"),(0,r.kt)("li",{parentName:"ul"},"XSUAA Service")),(0,r.kt)("h4",{id:"bind-the-destination-service"},"Bind the Destination Service"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create ",(0,r.kt)("inlineCode",{parentName:"li"},"yaml")," files for the destination service instance and binding:")),(0,r.kt)(o.$C,{mdxType:"OperatorDestinationService"}),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Install the configuration using the commands:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f operator-destination-service.yml\nkubectl apply -f operator-destination-binding.yml\n")),(0,r.kt)("p",null,"This should create a Kubernetes secret named ",(0,r.kt)("inlineCode",{parentName:"p"},"operator-destination-service"),".\nThis secret will contain the actual service binding information."),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Monitor the status via ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl describe ServiceInstance operator-destination-service"),".")),(0,r.kt)("h4",{id:"bind-the-xsuaa-service"},"Bind the XSUAA Service"),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"yaml")," files for the XSUAA service instance and binding:"),(0,r.kt)(o.SP,{mdxType:"OperatorXsuaaService"}),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Repeat steps 2 and 3 from the ",(0,r.kt)("a",{parentName:"li",href:"#bind-the-destination-service"},"previous section")," for the XSUAA service.\nReplace ",(0,r.kt)("inlineCode",{parentName:"li"},"destination")," with ",(0,r.kt)("inlineCode",{parentName:"li"},"xsuaa"),".")),(0,r.kt)("p",null,"We will see how to mount the created secrets into the file system of the application in the ",(0,r.kt)("a",{parentName:"p",href:"#create-a-deployment-configuration"},"deployment configuration")," step."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Notice that the ",(0,r.kt)("inlineCode",{parentName:"p"},"metadata -> name")," property can be anything you want.\nIn this case, it's ",(0,r.kt)("inlineCode",{parentName:"p"},"operator-destination-service"),".\nMake sure it matches exactly to the ",(0,r.kt)("inlineCode",{parentName:"p"},"spec -> serviceInstanceName")," field in the binding.")),(0,r.kt)("h2",{id:"deploy-to-kubernetes"},"Deploy to Kubernetes"),(0,r.kt)("p",null,"This section covers the following:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"How to deploy an application to Kubernetes."),(0,r.kt)("li",{parentName:"ol"},"How to consume the bound services in the application from within the cluster.")),(0,r.kt)("h3",{id:"containerize-the-application"},"Containerize the Application"),(0,r.kt)("p",null,"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," defining a container for the application.\nThen it can be deployed to one or more Kubernetes Pods."),(0,r.kt)(o.MK,{mdxType:"DockerFile"}),(0,r.kt)("p",null,"Compile and push the image by running:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t <YOUR_REPO>/<YOUR_IMAGE_NAME>:<YOUR_TAG> .\ndocker push <YOUR_REPO>/<YOUR_IMAGE_NAME>:<YOUR_TAG>\n")),(0,r.kt)("h3",{id:"create-a-deployment-configuration"},"Create a Deployment Configuration"),(0,r.kt)("p",null,"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"deployment.yml")," file as shown below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="app/deployment.yml"',title:'"app/deployment.yml"'},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sdkjs-e2e-deployment\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: sdkjs-e2e\n  template:\n    metadata:\n      labels:\n        app: sdkjs-e2e\n    spec:\n      containers:\n        - name: sdkjs-e2e\n          image: <YOUR_REPO>/k8s-e2e-app:latest\n          resources:\n            requests:\n              memory: '256Mi'\n              cpu: '500m'\n            limits:\n              memory: '512Mi'\n              cpu: '1000m'\n          ports:\n            - containerPort: 3000\n          volumeMounts:\n            - name: destination-volume\n              mountPath: '/etc/secrets/sapcp/destination/operator-destination-service'\n              readOnly: true\n            - name: xsuaa-volume\n              mountPath: '/etc/secrets/sapcp/xsuaa/operator-xsuaa-service'\n              readOnly: true\n      imagePullSecrets:\n        - name: regcred\n      volumes:\n        - name: destination-volume\n          secret:\n            secretName: operator-destination-service\n        - name: xsuaa-volume\n          secret:\n            secretName: operator-xsuaa-service\n")),(0,r.kt)("p",null,"The file contains the following data:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Resources definition"),": The ",(0,r.kt)("inlineCode",{parentName:"li"},"requests")," field specifies the CPU and memory requirements of the app.\nAdditionally, the resources can scale based on the values provided in the ",(0,r.kt)("inlineCode",{parentName:"li"},"limits")," field."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Service bindings"),": the volumes ",(0,r.kt)("inlineCode",{parentName:"li"},"destination-volume")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"xsuaa-volume")," reference the secrets (service bindings).\nThe volumes are mounted into the file system of your application at a specific path by adding them to the list of ",(0,r.kt)("inlineCode",{parentName:"li"},"volumeMounts")," in the ",(0,r.kt)("inlineCode",{parentName:"li"},"containers")," section.",(0,r.kt)("admonition",{parentName:"li",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The path convention is provided by the ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@sap/xsenv"},"xsenv")," library."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Container image and registry secrets"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"regcred")," secret used by the ",(0,r.kt)("inlineCode",{parentName:"li"},"imagePullSecrets")," config contains your registry credentials that you bound as a secret (in case the image was pushed to a private repository).")),(0,r.kt)("p",null,"Deploy the application by running the command:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"kubectl apply -f deployment.yml")),(0,r.kt)("h3",{id:"access-your-application"},"Access Your Application"),(0,r.kt)("p",null,"To access the application, you have two options.\nEither expose it to the internet directly or port-forward to your local machine."),(0,r.kt)("h4",{id:"local-connection"},"Local Connection"),(0,r.kt)("p",null,"Run the command ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl port-forward deployment YOUR_DEPLOYMENT :3000")," on your local machine to enable port forwarding.\nYour application will listen to port 3000.\nKubernetes finds an available port on your local machine and forwards port 3000 of your deployment to it.\nMake a call to the application via a provided link."),(0,r.kt)("h4",{id:"internet-facing-connection"},"Internet Facing Connection"),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"Exposing an application this way is good only for testing.\n",(0,r.kt)("strong",{parentName:"p"},"Don't use it in production."))),(0,r.kt)("p",null,"Run the command below to expose the application to the internet.\nIt will use the cluster's IP address and the port the application listens on."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'kubectl expose deployment YOUR_DEPLOYMENT --type="LoadBalancer"')),(0,r.kt)("h3",{id:"configure-tls-and-obtain-a-domain-in-sap-gardener"},"Configure TLS and Obtain a Domain in SAP Gardener"),(0,r.kt)("p",null,"If you want to expose your cluster under a domain name with TLS, check out the steps below or follow the official Kubernetes ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/"},"documentation")," for a general setup."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"mdxAdmonitionTitle"},"Prerequisite")),(0,r.kt)("p",{parentName:"admonition"},"Enable the NGINX Ingress add-on for your SAP Gardener cluster.")),(0,r.kt)("p",null,"The fastest way to enable TLS and obtain a domain for your application is to create a Service for your Deployment, and an Ingress to handle the routing.\nCreate a Service that contains your Deployment and the port you want to expose as shown in the example below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="app/k8s-e2e-service.yml"',title:'"app/k8s-e2e-service.yml"'},"apiVersion: v1\nkind: Service\nmetadata:\n  name: sdkjs-e2e-svc\nspec:\n  selector:\n    app: sdkjs-e2e\n  ports:\n    - port: 8080\n      targetPort: 3000\n")),(0,r.kt)("p",null,"Check your shoot cluster's ",(0,r.kt)("inlineCode",{parentName:"p"},"kubeconfig.yaml")," for the configured DNS, which should be located in your Gardener project's dashboard, under the YAML tab.\nIt should be a field that looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  dns:\n    domain: cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n")),(0,r.kt)("p",null,"Since the NGINX Ingress is enabled, all domains have to follow the pattern ",(0,r.kt)("inlineCode",{parentName:"p"},"*.ingress.YOUR_DNS"),", for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n")),(0,r.kt)("p",null,"This is how the Ingress configuration file should look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="ingress.yml"',title:'"ingress.yml"'},'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: sdkjs-e2e-ingress\n  annotations:\n    cert.gardener.cloud/purpose: managed\nspec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com # - "<YOUR_DNS>"\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com # - "*.ingress.<YOUR_DNS>"\n      secretName: secret-tls\n  rules:\n    - host: e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: sdkjs-e2e-svc\n                port:\n                  number: 8080\n')),(0,r.kt)("p",null,"Notice how the Ingress uses the annotation ",(0,r.kt)("inlineCode",{parentName:"p"},"cert.gardener.cloud/purpose: managed"),", which is important so that SAP Gardener manages TLS."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.tls.hosts")," config exposes 2 domains.\nThe first one is your default domain, limited to a maximum of 64 characters.\nOther domains can be any size, but should follow the Ingress pattern."),(0,r.kt)("p",null,"The field ",(0,r.kt)("inlineCode",{parentName:"p"},"secretName: secret-tls")," in the configuration implies that all TLS certificates will be saved by SAP Gardener.\nFinally, look at how to serve the Service at the root of your subdomain.\nThis way the Service is exposed to the internet using TLS."),(0,r.kt)("h3",{id:"expose-the-application-using-approuter"},"Expose the Application using Approuter"),(0,r.kt)("p",null,"In the next steps, you will configure and deploy an approuter so that only users authenticated by your identity provider can access the application endpoints.\nFor that, create a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/k8s-sample-application/approuter"},"simple application")," that uses the @sap/approuter."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Package the application router as a docker image so that it can run in Kubernetes, refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://blogs.sap.com/2020/04/03/sap-application-router/"},"documentation")," for configuration details.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a Kubernetes Deployment and a Kubernetes Service to run and expose the application router."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="approuter/deployment.yml"',title:'"approuter/deployment.yml"'},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: approuter\n  labels:\n    app: approuter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: approuter\n  template:\n    metadata:\n      labels:\n        app: approuter\n    spec:\n      containers:\n        - image: <YOUR_REPO>/k8s-approuter:latest\n          resources:\n            requests:\n              memory: '256Mi'\n              cpu: '250m'\n            limits:\n              memory: '512Mi'\n              cpu: '500m'\n          name: approuter\n          volumeMounts:\n            - name: xsuaa-volume\n              mountPath: '/etc/secrets/sapcp/xsuaa/operator-xsuaa-service'\n              readOnly: true\n          env:\n            - name: PORT\n              value: '5000'\n            - name: destinations\n              value: '[{\"name\":\"backend\", \"url\":\"http://sdkjs-e2e-svc:8080/\", \"forwardAuthToken\": true}]'\n      imagePullSecrets:\n        - name: regcred\n      volumes:\n        - name: xsuaa-volume\n          secret:\n            secretName: operator-xsuaa-service\n")),(0,r.kt)("p",null,"It references the application running in your cluster.\nInstead of an Ingress endpoint, it directly points to the Service.\nThis is possible because the application router runs in your cluster and can therefore use the Kubernetes native Service discovery."),(0,r.kt)("p",null,"The Service configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="approuter/approuter-service.yml"',title:'"approuter/approuter-service.yml"'},"apiVersion: v1\nkind: Service\nmetadata:\n  name: approuter-svc\n  labels:\n    app: approuter\nspec:\n  ports:\n    - port: 8080\n      targetPort: 5000\n  selector:\n    app: approuter\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Finally, configure the Ingress to create a session cookie that is consumed by the application router.\nSet the ",(0,r.kt)("inlineCode",{parentName:"li"},"backend.service.name")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"approuter-svc")," to point the Ingress to the ",(0,r.kt)("inlineCode",{parentName:"li"},"approuter")," Service.\nTo secure your application, remove all previous routes that pointed to your application's endpoints and only expose them through the application router.\nFor that, specify the Service names in your approuter destinations' configuration and remove the rules you previously created for these endpoints in the Ingress.")),(0,r.kt)("p",null,"Depending on the Ingress controller, you have to use different annotations.\nAn Ingress that only exposes the application router and uses the annotations is shown in the following example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="ingress.yml"',title:'"ingress.yml"'},"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: sdkjs-e2e-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/affinity: 'cookie'\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '600'\n    nginx.ingress.kubernetes.io/session-cookie-name: 'JSESSIONID'\n    cert.gardener.cloud/purpose: managed\nspec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n  rules:\n    - host: e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: approuter-svc\n                port:\n                  number: 8080\n")),(0,r.kt)("h2",{id:"principal-propagation"},"Principal Propagation"),(0,r.kt)("p",null,"Just as in SAP BTP Cloud Foundry, you have to collect the principal's JSON web token (JWT) from the authentication header after executing one of the requests with the typed client libraries.\nThe example below uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"retrieveJwt()")," function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { Injectable } from '@nestjs/common';\nimport { retrieveJwt } from '@sap-cloud-sdk/connectivity';\nimport { Request } from 'express';\nimport { businessPartnerService } from './generated/business-partner-service';\n\n@Injectable()\nexport class PrincipalBusinessPartnerService {\n  async getFiveBusinessPartners(request: Request): Promise<BusinessPartner[]> {\n    return BusinessPartner.requestBuilder()\n      .getAll()\n      .top(5)\n      .execute({\n        destinationName: 'MY-DESTINATION',\n        jwt: retrieveJwt(request)\n      });\n  }\n}\n")),(0,r.kt)("h2",{id:"on-premise-connectivity"},"On-Premise Connectivity"),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"On-Premise connectivity in Kubernetes is not available for SAP customers as of July 2023.")),(0,r.kt)("p",null,"You need a connectivity proxy to connect to on-premise systems inside a Kubernetes cluster.\nThe following steps show how to create and use it."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a route with TLS enabled for the connectivity proxy.\nTo enable TLS on SAP Gardener, refer to the ",(0,r.kt)("a",{parentName:"li",href:"#configure-tls-and-obtain-a-domain-in-sap-gardener"},'"Configure TLS and Obtain a Domain in SAP Gardener"')," section.\nIf your cluster is not backed by SAP Gardener, refer to the official ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/"},"Kubernetes documentation"),".")),(0,r.kt)("p",null,"This example shows how to add the custom domain ",(0,r.kt)("inlineCode",{parentName:"p"},"connectivitytunnel.*")," to the TLS section in SAP Gardener.\nThis creates a certificate for this domain automatically."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - connectivitytunnel.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Add your CA certificate to the JVM trust store of the SAP Cloud Connector.\nThe CA certificate is stored in the TLS secret, in this case the name is ",(0,r.kt)("inlineCode",{parentName:"li"},"secret-tls"),".")),(0,r.kt)("p",null,"To access the information inside a secret, use the following code snippet:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl get secret YOUR_SECRET -o go-template=\'{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\\n"}}{{end}}\'\n')),(0,r.kt)("p",null,"Inside the secret should be a block prefixed with ",(0,r.kt)("inlineCode",{parentName:"p"},"ca.crt"),".\nCopy this certificate into a file and then follow ",(0,r.kt)("a",{parentName:"p",href:"https://connect2id.com/blog/importing-ca-root-cert-into-jvm-trust-store"},"this guide")," to add it to the JVM trust store of your SAP Cloud Connector."),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create and bind the connectivity service with the ",(0,r.kt)("inlineCode",{parentName:"p"},"connectivty_proxy")," plan following the steps shown ",(0,r.kt)("a",{parentName:"p",href:"#bind-the-destination-service"},"before"),".\nAdditionally, to bind the secret represented by Kubernetes native YAML format, you need to convert it to JSON format for the connectivity proxy to consume it.\nUse the code snippet in step (2) above to retrieve the values of the secret."),(0,r.kt)("p",{parentName:"li"},"Here is an example JSON secret:"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Secret\nmetadata:\n  name: connectivity-proxy-service-key\ntype: Opaque\nstringData:\n  connectivity_key: \'{\n    "clientid": "YOUR_CLIENT_ID",\n    "clientsecret": "YOUR_CLIENT_SECRET",\n    "xsappname": "YOUR_XS_APP_NAME",\n    "connectivity_service": {\n        "CAs_path":"/api/v1/CAs",\n        "CAs_signing_path":"/api/v1/CAs/signing",\n        "api_path":"/api/v1",\n        "tunnel_path":"/api/v1/tunnel",\n        "url":"https://connectivity.cf.sap.hana.ondemand.com"\n    },\n    "subaccount_id": "YOUR_SUBACCOUNT_ID",\n    "subaccount_subdomain": "YOUR_SUBACCOUNT_SUBDOMAIN",\n    "token_service_domain": "YOUR_TOKEN_SERVICE_DOMAIN",\n    "token_service_url": "YOUR_TOKEN_SERVICE_URL",\n    "token_service_url_pattern": "https://{tenant}.authentication.sap.hana.ondemand.com/oauth/token",\n    "token_service_url_pattern_tenant_key": "subaccount_subdomain"\n}\'\n')),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Note that the example used the ",(0,r.kt)("inlineCode",{parentName:"p"},"stringData")," field type instead of the default ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," field type to benefit from automatic base64 encoding.\nThis is a requirement of the connectivity proxy since it can't consume the data of the secret in YAML format.")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download the CA certificate of the connectivity service and create a secret that includes:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"the CA certificate of the connectivity service"),(0,r.kt)("li",{parentName:"ul"},"your private key"),(0,r.kt)("li",{parentName:"ul"},"your public certificate")))),(0,r.kt)("p",null,"The private key and public certificate are also stored in the TLS secret.\nUse the previous code snippet to retrieve it from the secret and save them in separate files.\nFinally, download the CA certificate with the following line:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl https://connectivity.cf.sap.hana.ondemand.com/api/v1/CAs/signing -o connectivity_ca.crt\n")),(0,r.kt)("p",null,"Now, create the secret with this command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create secret generic connectivity-tls --from-file=ca.crt=YOUR_CONNECTIVITY_CA_KEY.crt --from-file=tls.key=YOUR_PRIVATE_KEY.key --from-file=tls.crt=YOUR_PUBLIC_KEY.crt --namespace default\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a secret that contains credentials to access the docker image which the connectivity proxy is using.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml")," file containing the configuration that suits your desired operational mode of the connectivity proxy, for the available operational modes refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://help.sap.com/viewer/cca91383641e40ffbe03bdc78f00f681/Cloud/en-US/f3c1ef45db77489c8d039acc9530358f.html"},"documentation"),".\nFor the specific content of the configuration refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://help.sap.com/viewer/cca91383641e40ffbe03bdc78f00f681/Cloud/en-US/eaa8204fc7484df984b3c321624827ff.html"},"configuration guide"),"."))),(0,r.kt)("p",null,'Here is an example for the "single tenant in a trusted environment" mode:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"deployment:\n  replicaCount: 1\n  image:\n    pullSecret: 'proxy-secret'\ningress:\n  tls:\n    secretName: 'connectivity-tls'\nconfig:\n  integration:\n    auditlog:\n      mode: console\n    connectivityService:\n      serviceCredentialsKey: 'connectivity_key'\n  tenantMode: dedicated\n  subaccountId: 'YOUR_SUBACCOUNT_ID'\n  subaccountSubdomain: 'YOUR_SUBACCOUNT_SUBDOMAIN'\n  servers:\n    businessDataTunnel:\n      externalHost: 'connectivitytunnel.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com'\n      externalPort: 443\n    proxy:\n      rfcAndLdap:\n        enabled: true\n        enableProxyAuthorization: false\n      http:\n        enabled: true\n        enableProxyAuthorization: false\n        enableRequestTracing: true\n      socks5:\n        enableProxyAuthorization: false\n")),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},"For your application to reach on-premise destinations, it needs to provide the proxy settings and the token URL.\nAdd them manually to the ",(0,r.kt)("inlineCode",{parentName:"li"},"secret")," containing the service binding using the following code snippet:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl edit secret YOUR_BINDING\n")),(0,r.kt)("p",null,"Now add the fields ",(0,r.kt)("inlineCode",{parentName:"p"},"onpremise_proxy_host")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"onpremise_proxy_port")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"url"),".\nThe host has the pattern ",(0,r.kt)("inlineCode",{parentName:"p"},"connectivity-proxy.YOUR_NAMESPACE")," which in this case is ",(0,r.kt)("inlineCode",{parentName:"p"},"connectivity-proxy.default"),".\nThe default port is ",(0,r.kt)("inlineCode",{parentName:"p"},"20003"),".\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"url")," field should contain the same value as ",(0,r.kt)("inlineCode",{parentName:"p"},"token_service_url"),".\nBe aware that the values have to be encoded in base64, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"onpremise_proxy_host: Y29ubmVjdGl2aXR5LXByb3h5LmRlZmF1bHQ=\nonpremise_proxy_port: MjAwMDM=\nurl: aHR0cHM6Ly9teS1hcGkuYXV0aGVudGljYXRpb24uc2FwLmhhbmEub25kZW1hbmQuY29tCg==\n")),(0,r.kt)("ol",{start:8},(0,r.kt)("li",{parentName:"ol"},"Finally, add the binding to your ",(0,r.kt)("inlineCode",{parentName:"li"},"deployment.yml"),", the same way you would add any other binding.")),(0,r.kt)("h2",{id:"create-a-continuous-integration-pipeline"},"Create a Continuous Integration Pipeline"),(0,r.kt)("p",null,"You can create a simple CI/CD pipeline with GitHub Actions or change your existing pipeline.\nFollow the steps below to create a service account and obtain the authentication tokens and certificates needed to interact with your cluster within the pipeline."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/"},"Create a service account")," in your cluster."),(0,r.kt)("li",{parentName:"ol"},"Bind the ",(0,r.kt)("inlineCode",{parentName:"li"},"cluster-admin")," cluster role to the service account.\nAlternatively, create a more strict role."),(0,r.kt)("li",{parentName:"ol"},"Obtain the token and CA certificate from the secret that is automatically created for that service account."),(0,r.kt)("li",{parentName:"ol"},"Obtain the cluster API endpoint via command ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl cluster-info"),".")),(0,r.kt)("p",null,"Use the service account in your automation to connect to the cluster:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl config set-cluster gardener --server=YOUR_CLUSTER_API_ENDPOINT\nkubectl config set-context gardener --cluster=gardener\nkubectl config use-context gardener\nkubectl config view\nkubectl --token=${{ secrets.KUBERNETES_SERVICE_TOKEN }} --certificate-authority YOUR_CA_CERT_PATH cluster-info\n")),(0,r.kt)("p",null,"After completing the previous steps, run the command below to shutdown and restart all the Pods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --token=${{ secrets.KUBERNETES_SERVICE_TOKEN }} --certificate-authority YOUR_CA_CERT_PATH rollout restart deployment/YOUR_DEPLOYMENT\n")),(0,r.kt)("p",null,"If the Deployment is configured with ",(0,r.kt)("inlineCode",{parentName:"p"},"ImagePullStrategy: Always"),", it will pull the updated image and use it."))}d.isMDXComponent=!0},96386:(e,t,n)=>{n.d(t,{$C:()=>p,MK:()=>c,R:()=>d,SP:()=>u,Sw:()=>m});var a=n(67294),r=n(42779),o=n(3431),i=n(74937),s=n(18877),l=n(18052);function c(){return a.createElement(i.default,null)}function p(){return a.createElement(s.default,null)}function u(){return a.createElement(l.default,null)}function d(){return a.createElement(r.default,null)}function m(){return a.createElement(o.default,null)}},85162:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),r=n(34334);const o="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,i),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>C});var a=n(87462),r=n(67294),o=n(34334),i=n(12466),s=n(76775),l=n(91980),c=n(67392),p=n(50012);function u(e){return function(e){var t;return(null==(t=r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})))?void 0:t.filter(Boolean))??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}function d(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??u(n);return function(e){const t=(0,c.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const a=(0,s.k6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(o),(0,r.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(a.location.search);t.set(o,e),a.replace({...a.location,search:t.toString()})}),[o,a])]}function k(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,o=d(e),[i,s]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:o}))),[l,c]=h({queryString:n,groupId:a}),[u,k]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,o]=(0,p.Nk)(n);return[a,(0,r.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:a}),v=(()=>{const e=l??u;return m({value:e,tabValues:o})?e:null})();(0,r.useLayoutEffect)((()=>{v&&s(v)}),[v]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);s(e),c(e),k(e)}),[c,k,o]),tabValues:o}}var v=n(72389);const f="tabList__CuJ",y="tabItem_LNqP";function g(e){let{className:t,block:n,selectedValue:s,selectValue:l,tabValues:c}=e;const p=[],{blockElementScrollPositionUntilNextRender:u}=(0,i.o5)(),d=e=>{const t=e.currentTarget,n=p.indexOf(t),a=c[n].value;a!==s&&(u(t),l(a))},m=e=>{var t;let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=p.indexOf(e.currentTarget)+1;n=p[t]??p[0];break}case"ArrowLeft":{const t=p.indexOf(e.currentTarget)-1;n=p[t]??p[p.length-1];break}}null==(t=n)||t.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":n},t)},c.map((e=>{let{value:t,label:n,attributes:i}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>p.push(e),onKeyDown:m,onClick:d},i,{className:(0,o.Z)("tabs__item",y,null==i?void 0:i.className,{"tabs__item--active":s===t})}),n??t)})))}function b(e){let{lazy:t,children:n,selectedValue:a}=e;const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=o.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},o.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function N(e){const t=k(e);return r.createElement("div",{className:(0,o.Z)("tabs-container",f)},r.createElement(g,(0,a.Z)({},e,t)),r.createElement(b,(0,a.Z)({},e,t)))}function C(e){const t=(0,v.Z)();return r.createElement(N,(0,a.Z)({key:String(t)},e))}}}]);