"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[924],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),d=u(n),h=r,m=d["".concat(s,".").concat(h)]||d[h]||c[h]||o;return n?a.createElement(m,i(i({ref:t},l),{},{components:n})):a.createElement(m,i({ref:t},l))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p.mdxType="string"==typeof e?e:r,i[1]=p;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3716:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>p,metadata:()=>u,toc:()=>c});var a=n(87462),r=(n(67294),n(3905)),o=n(50941),i=n(44996);const p={id:"approuter",title:"Using the SAP Application Router with the SAP Cloud SDK",sidebar_label:"Using the SAP Application Router",description:"This article describes how you can use the SAP Application Router with the SAP Cloud SDK",keywords:["sap","cloud","sdk","approuter","multi-tenancy","cloud-foundry","JavaScript","TypeScript"]},s="Using the SAP Application Router with the SAP Cloud SDK",u={unversionedId:"guides/approuter",id:"guides/approuter",title:"Using the SAP Application Router with the SAP Cloud SDK",description:"This article describes how you can use the SAP Application Router with the SAP Cloud SDK",source:"@site/docs-js/guides/how-to-use-the-approuter.mdx",sourceDirName:"guides",slug:"/guides/approuter",permalink:"/cloud-sdk/docs/js/v3/guides/approuter",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js/guides/how-to-use-the-approuter.mdx",tags:[],version:"current",frontMatter:{id:"approuter",title:"Using the SAP Application Router with the SAP Cloud SDK",sidebar_label:"Using the SAP Application Router",description:"This article describes how you can use the SAP Application Router with the SAP Cloud SDK",keywords:["sap","cloud","sdk","approuter","multi-tenancy","cloud-foundry","JavaScript","TypeScript"]},sidebar:"docsJsSidebar",previous:{title:"Trust and Keystores",permalink:"/cloud-sdk/docs/js/v3/guides/trust-and-keystores"},next:{title:"How to Add Resilience",permalink:"/cloud-sdk/docs/js/v3/guides/resilience"}},l={},c=[{value:"SAP Application Router",id:"sap-application-router",level:2},{value:"Application Router Setup",id:"application-router-setup",level:3},{value:"Securing Your Application",id:"securing-your-application",level:2},{value:"Enabling Principal Propagation",id:"enabling-principal-propagation",level:2}],d={toc:c};function h(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"using-the-sap-application-router-with-the-sap-cloud-sdk"},"Using the SAP Application Router with the SAP Cloud SDK"),(0,r.kt)("p",null,"This guide will show you how to use the SAP Application Router together with the SAP Cloud SDK.\nYou will learn how to secure your application and configure multi-tenancy for principal propagation with an SAP Cloud SDK-based application example powered by ",(0,r.kt)("a",{parentName:"p",href:"https://nestjs.com/"},"nestJS"),"."),(0,r.kt)("h2",{id:"sap-application-router"},"SAP Application Router"),(0,r.kt)("p",null,"To enable multi-tenancy for your application, you should use the ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@sap/approuter"},"SAP Application Router"),".\nThe application router\u2019s primary purpose is to be the single entry point of a microservice-based application and act as the application\u2019s reverse proxy."),(0,r.kt)("p",null,"Its responsibilities consist of dispatching requests to backend microservices, authenticating users, and serving static content.\nThe application router checks if a given request has a valid JSON Web Token (JWT) when accessing a target service.\nIf the request contains a valid JWT, the application router forwards the request to the target service; if the request does not contain a valid JWT, the user must authenticate.\nWhen using an Identity Provider (IdP) to authenticate, the request is redirected to the IdP where a user gets authenticated and then redirected back to the application router."),(0,r.kt)(o.Z,{alt:"Application Router flow",sources:{light:(0,i.Z)("img/approuter_light.svg"),dark:(0,i.Z)("img/approuter_dark.svg")},className:"center",width:"80%",mdxType:"ThemedImage"}),(0,r.kt)("h3",{id:"application-router-setup"},"Application Router Setup"),(0,r.kt)("p",null,"To deploy your application router in SAP BTP Cloud Foundry, you need to configure it first.\nLet's walk through the four files you need to use."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"xs-security.json")," file defines the security and deployment options for an application.\nWith the below example, you enable the ",(0,r.kt)("inlineCode",{parentName:"p"},"shared")," tenant-mode for your ",(0,r.kt)("inlineCode",{parentName:"p"},"xsuaa")," instance, which you need to enable multi-tenancy."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "xsappname": "approuter-scaffold",\n  "tenant-mode": "shared"\n}\n')),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"xs-app.json"),", you specify to which backend service a request is forwarded to, and how this request has to be authenticated.\nYou can optionally specify a specific ",(0,r.kt)("inlineCode",{parentName:"p"},"identityProvider")," that is used for the authentication."),(0,r.kt)("p",null,"In the example below, you forward every request against the application router's ",(0,r.kt)("inlineCode",{parentName:"p"},"/")," route to the backend destination's ",(0,r.kt)("inlineCode",{parentName:"p"},"/")," route."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "welcomeFile": "index.html",\n  "routes": [\n    {\n      "source": "/",\n      "target": "/",\n      "destination": "approuter-scaffold"\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," there is only one dependency, the application router module."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "approuter",\n  "dependencies": {\n    "@sap/approuter": "*"\n  },\n  "scripts": {\n    "start": "node node_modules/@sap/approuter/approuter.js"\n  }\n}\n')),(0,r.kt)("p",null,"The manifest contains your application router, as well as environment variables which your application router needs for multi-tenancy.\nUnder ",(0,r.kt)("inlineCode",{parentName:"p"},"env"),", you need to specify the ",(0,r.kt)("inlineCode",{parentName:"p"},"TENANT_HOST_PATTERN")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"destinations"),".\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"destinations")," are the destinations you use in your ",(0,r.kt)("inlineCode",{parentName:"p"},"xs-app.json")," where you forward requests to.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"TENANT_HOST_PATTERN")," is a regular expression that describes how a tenant name should be retrieved from the host.\nYou also have to bind the ",(0,r.kt)("inlineCode",{parentName:"p"},"xsuaa")," which you configured with your ",(0,r.kt)("inlineCode",{parentName:"p"},"xs-security.json")," to the application router."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'applications:\n  - name: approuter-scaffold-approuter\n    routes:\n      - route: >-\n          approuter-scaffold-apps.cfapps.sap.hana.ondemand.com\n    path: .\n    memory: 128M\n    buildpacks:\n      - nodejs_buildpack\n    env:\n      TENANT_HOST_PATTERN: >-\n        "approuter-scaffold-(.*).cfapps.sap.hana.ondemand.com"\n      destinations: >-\n        [{"name":"approuter-scaffold","url":"approuter-scaffold.cfapps.sap.hana.ondemand.com","forwardAuthToken":true}]\n    services:\n      - approuter-scaffold-xsuaa\n')),(0,r.kt)("h2",{id:"securing-your-application"},"Securing Your Application"),(0,r.kt)("p",null,"Utilize the ",(0,r.kt)("a",{parentName:"p",href:"http://www.passportjs.org/packages/passport-jwt"},"passport")," library to secure your application endpoints.\nIt lets you authenticate endpoints using a JSON web token."),(0,r.kt)("p",null,"Additionally, the ",(0,r.kt)("inlineCode",{parentName:"p"},"xsenv")," library can retrieve your ",(0,r.kt)("inlineCode",{parentName:"p"},"xsuaa")," credentials and the ",(0,r.kt)("inlineCode",{parentName:"p"},"xssec")," library's ",(0,r.kt)("inlineCode",{parentName:"p"},"JWTStrategy")," object for the middleware."),(0,r.kt)("p",null,"Below is a simple example, where you get the ",(0,r.kt)("inlineCode",{parentName:"p"},"approuter-scaffold-xsuaa")," which is bound to your application, use it in the ",(0,r.kt)("inlineCode",{parentName:"p"},"JWTStrategy"),", and then forward the middleware to the passport."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { JWTStrategy } from '@sap/xssec';\nimport { getServices } from '@sap/xsenv';\nimport * as passport from 'passport';\n\nconst xsuaa = getServices({\n  xsuaa: { name: 'approuter-scaffold-xsuaa' }\n}).xsuaa;\npassport.use(new JWTStrategy(xsuaa));\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  app.use(passport.initialize());\n  app.use(passport.authenticate('JWT', { session: false }));\n  await app.listen(process.env.PORT || 3000);\n}\nbootstrap();\n")),(0,r.kt)("h2",{id:"enabling-principal-propagation"},"Enabling Principal Propagation"),(0,r.kt)("p",null,"To enable principal propagation with this setup, you must forward the request to the endpoints."),(0,r.kt)("p",null,"First, you forward the request in your ",(0,r.kt)("inlineCode",{parentName:"p"},"app.controller.ts")," to the principal propagation endpoint."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"@Get('principal-business-partner')\n  getPrincipalBusinessPartner(\n    @Req() request: Request,\n  ): Promise<BusinessPartner[]> {\n    return this.principalBusinessPartnerService.getFiveBusinessPartners(\n      request,\n    );\n  }\n")),(0,r.kt)("p",null,"Then, you can use the SAP Cloud SDK's ",(0,r.kt)("inlineCode",{parentName:"p"},"retrieveJwt()")," function to extract the JWT from your request, and forward it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"execute()")," method."),(0,r.kt)("p",null,"Below is an example using the ",(0,r.kt)("inlineCode",{parentName:"p"},"BusinessPartnerService")," showing how to retrieve the top five business partners."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { Injectable } from '@nestjs/common';\nimport { retrieveJwt } from '@sap-cloud-sdk/connectivity';\nimport { Request } from 'express';\nimport { businessPartnerService } from './generated/business-partner-service';\n\n@Injectable()\nexport class PrincipalBusinessPartnerService {\n  async getFiveBusinessPartners(request: Request): Promise<BusinessPartner[]> {\n    return BusinessPartner.requestBuilder()\n      .getAll()\n      .top(5)\n      .execute({\n        destinationName: 'MY-DESTINATION',\n        jwt: retrieveJwt(request)\n      });\n  }\n}\n")))}h.isMDXComponent=!0}}]);