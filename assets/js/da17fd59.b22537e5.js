"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[8317],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(n),h=r,m=u["".concat(l,".").concat(h)]||u[h]||c[h]||o;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},10838:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var a=n(87462),r=(n(67294),n(3905));const o={id:"thread-context",title:"Multitenancy With the Thread Context",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Thread Context",description:"This article describes how the SAP Cloud SDK for Java provides an application context that is stored in a thread-safe manner and enables cloud-native features to be used out of the box.",keywords:["sap","cloud","sdk","thread context","multi tenancy","cloud native","tenant","user","principal","JWT","AuthToken"]},i=void 0,s={unversionedId:"features/multi-tenancy/thread-context",id:"version-v5/features/multi-tenancy/thread-context",title:"Multitenancy With the Thread Context",description:"This article describes how the SAP Cloud SDK for Java provides an application context that is stored in a thread-safe manner and enables cloud-native features to be used out of the box.",source:"@site/docs-java_versioned_docs/version-v5/features/multi-tenancy/thread-context.mdx",sourceDirName:"features/multi-tenancy",slug:"/features/multi-tenancy/thread-context",permalink:"/cloud-sdk/docs/java/v5/features/multi-tenancy/thread-context",draft:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-java_versioned_docs/version-v5/features/multi-tenancy/thread-context.mdx",tags:[],version:"v5",frontMatter:{id:"thread-context",title:"Multitenancy With the Thread Context",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Thread Context",description:"This article describes how the SAP Cloud SDK for Java provides an application context that is stored in a thread-safe manner and enables cloud-native features to be used out of the box.",keywords:["sap","cloud","sdk","thread context","multi tenancy","cloud native","tenant","user","principal","JWT","AuthToken"]},sidebar:"docsJavaSidebar",previous:{title:"Certificate-based Authentication",permalink:"/cloud-sdk/docs/java/v5/features/connectivity/mtls"},next:{title:"Resilience",permalink:"/cloud-sdk/docs/java/v5/features/resilience/"}},l={},d=[{value:"What Is a Thread Context?",id:"what-is-a-thread-context",level:2},{value:"How Is a Thread Context Created?",id:"how-is-a-thread-context-created",level:2},{value:"Running Asynchronous Operations",id:"running-asynchronous-operations",level:2},{value:"Spring Integration",id:"spring-integration",level:3},{value:"Passing on Other ThreadLocals",id:"passing-on-other-threadlocals",level:3},{value:"Configuring the Executor",id:"configuring-the-executor",level:3},{value:"Modifying the ThreadContext",id:"modifying-the-threadcontext",level:3},{value:"How Can the Thread Context Be Used?",id:"how-can-the-thread-context-be-used",level:2},{value:"Accessing Information",id:"accessing-information",level:3},{value:"Storing Information",id:"storing-information",level:3},{value:"Manipulating HTTP Headers",id:"manipulating-http-headers",level:3},{value:"Create a new RequestHeaderContainer From Scratch",id:"create-a-new-requestheadercontainer-from-scratch",level:4},{value:"Updating an Existing RequestHeaderContainer",id:"updating-an-existing-requestheadercontainer",level:4}],p={toc:d};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"what-is-a-thread-context"},"What Is a Thread Context?"),(0,r.kt)("p",null,"The SAP Cloud SDK for Java provides a so-called ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext"),".\nIt serves as thread-safe storage for potentially sensitive information.\nSpecifically, the following three objects are stored:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The current ",(0,r.kt)("em",{parentName:"li"},"Tenant")),(0,r.kt)("li",{parentName:"ul"},"The current ",(0,r.kt)("em",{parentName:"li"},"Principal")," (User)"),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("a",{parentName:"li",href:"https://jwt.io"},"JSON Web Token")," (JWT)")),(0,r.kt)("p",null,"This information is used throughout the SAP Cloud SDK to provide features like tenant and principal isolation, JWT verification and authorization against other systems and services.\nTo ensure different tenants and users are properly isolated in an application, this information is always limited to the thread it was created on unless it is explicitly passed on by the application (see ",(0,r.kt)("a",{parentName:"p",href:"#running-asynchronous-operations"},"Propagating the Thread Context"),")."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Multi-tenancy describes the access of different, technically separated user groups to the same instance of an application.\nIn the terms of XSUAA service, these user groups are called Tenants, while in terms of Identity Authentication Service (IAS) they are called Zones."),(0,r.kt)("p",{parentName:"admonition"},"The SAP Cloud SDK for Java uses the term ",(0,r.kt)("em",{parentName:"p"},"Tenant")," to refer to both XSUAA Tenants and IAS Zones.\nThis implies, that the ",(0,r.kt)("em",{parentName:"p"},"tenantId")," exposed in the ",(0,r.kt)("em",{parentName:"p"},"Tenant")," interface either returns the ",(0,r.kt)("em",{parentName:"p"},"tenantId")," or ",(0,r.kt)("em",{parentName:"p"},"zoneId"),", depending on the context you are currently running in.")),(0,r.kt)("h2",{id:"how-is-a-thread-context-created"},"How Is a Thread Context Created?"),(0,r.kt)("p",null,"The SAP Cloud SDK provides a ",(0,r.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/servlet/RequestAccessorFilter.html"},(0,r.kt)("inlineCode",{parentName:"a"},"RequestFilter"))," that will listen to incoming HTTP requests.\nThis filter will extract ",(0,r.kt)("strong",{parentName:"p"},"all")," provided HTTP headers from the incoming request and store them in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext"),".\nAdditionally, if the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," header contains a ",(0,r.kt)("inlineCode",{parentName:"p"},"JWT")," from the ",(0,r.kt)("a",{parentName:"p",href:"https://blogs.sap.com/2020/04/03/sap-application-router/"},(0,r.kt)("inlineCode",{parentName:"a"},"AppRouter")),", the filter will:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify this token"),(0,r.kt)("li",{parentName:"ul"},"Store it in the ",(0,r.kt)("inlineCode",{parentName:"li"},"ThreadContext")," and"),(0,r.kt)("li",{parentName:"ul"},"Pull the ",(0,r.kt)("em",{parentName:"li"},"Tenant")," and ",(0,r.kt)("em",{parentName:"li"},"Principal")," information from it")),(0,r.kt)("admonition",{title:"Integration with CAP",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"In case you are using CAP (with the ",(0,r.kt)("inlineCode",{parentName:"p"},"cds-integration-cloud-sdk")," dependency) the Tenant, Principal, and Headers will ",(0,r.kt)("strong",{parentName:"p"},"instead")," be derived from the ",(0,r.kt)("a",{parentName:"p",href:"https://cap.cloud.sap/docs/java/request-contexts"},"CAP Request Context"),".\nThat also means that the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext")," will not be used when accessing this information.")),(0,r.kt)("h2",{id:"running-asynchronous-operations"},"Running Asynchronous Operations"),(0,r.kt)("p",null,"As the name suggests, the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext")," is bound to a thread, more specifically to the one it was created in.\nIn consequence, other threads, i.e. asynchronous operations, cannot access the stored information if it hasn't been explicitly propagated."),(0,r.kt)("p",null,"The SAP Cloud SDK offers a dedicated API to execute asynchronous operations while preserving the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext"),"."),(0,r.kt)("p",null,"Given any operation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"Callable myTask = () -> doStuff();\n// or\nRunnable myTask = () -> doStuff();\n")),(0,r.kt)("p",null,"The operation can be executed asynchronously via:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"Future runningTask = ThreadContextExecutors.submit(myTask);\n")),(0,r.kt)("p",null,"Operations that are submitted this way will be executed by a single instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextExecutorService"),".\nBy default, this instance is based on a ",(0,r.kt)("inlineCode",{parentName:"p"},"CachedThreadPool"),", which manages the concurrency internally."),(0,r.kt)("p",null,"For executing multiple asynchronous operations we recommend the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"List<Callable> tasks;\nThreadContextExecutorService executor = ThreadContextExecutors.getExecutor();\nList<Future> runningTasks = executor.invokeAll(tasks);\n")),(0,r.kt)("h3",{id:"spring-integration"},"Spring Integration"),(0,r.kt)("p",null,"You can conveniently integrate this functionality to work with Springs ",(0,r.kt)("inlineCode",{parentName:"p"},"@Async")," annotation."),(0,r.kt)("p",null,"The configuration below will ensure all methods annotated with ",(0,r.kt)("inlineCode",{parentName:"p"},"@Async")," will have the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext")," available:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@EnableAsync\n@Configuration\npublic class AsynchronousConfiguration implements AsyncConfigurer {\n\n  @Override\n  public Executor getAsyncExecutor() {\n    return ThreadContextExecutors.getExecutor();\n  }\n}\n\n")),(0,r.kt)("p",null,"You can read more about the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Async")," functionality ",(0,r.kt)("a",{parentName:"p",href:"https://www.baeldung.com/spring-async"},"here"),"."),(0,r.kt)("admonition",{title:"Security Context",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"The Spring ",(0,r.kt)("inlineCode",{parentName:"p"},"SecurityContext")," can be propagated to ",(0,r.kt)("inlineCode",{parentName:"p"},"@Async")," calls.\nReplace the above executor with this one:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"new DelegatingSecurityContextExecutor(ThreadContextExecutors.getExecutor());\n")),(0,r.kt)("p",{parentName:"admonition"},"And add this dependency:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<dependency>\n    <groupId>org.springframework.security</groupId>\n    <artifactId>spring-security-core</artifactId>\n</dependency>\n"))),(0,r.kt)("h3",{id:"passing-on-other-threadlocals"},"Passing on Other ThreadLocals"),(0,r.kt)("p",null,"Other libraries and frameworks may also rely on ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadLocal")," variables to hold contextual data.\nFor example, the CAP ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestContext")," is also bound to the current Thread."),(0,r.kt)("p",null,"To not lose this state when creating a new Thread they can be passed on by implementing a ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextDecorator"),".\nA typical implementation for this purpose should look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\npublic <T> Callable<T> decorateCallable( @Nonnull final Callable<T> callable ) {\n  Object valueToPass = YourThreadLocal.get();\n\n  return () -> {\n    Object initial = YourThreadLocal.get();\n    YourThreadLocal.set(valueToPass);\n    try {\n      return callable.call();\n    }\n    finally {\n      YourThreadLocal.set(initial);\n    }\n  };\n}\n")),(0,r.kt)("p",null,"Such a custom ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextDecorator")," can be registered via ",(0,r.kt)("inlineCode",{parentName:"p"},"DefaultThreadContextDecoratorChain.registerDefaultDecorator"),"."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"The SAP Cloud SDK already comes with a default decorator that passes on the ",(0,r.kt)("inlineCode",{parentName:"p"},"SecurityContext")," of ",(0,r.kt)("inlineCode",{parentName:"p"},"com.sap.cloud.security:java-api"),".\nIf the ",(0,r.kt)("a",{parentName:"p",href:"/cloud-sdk/docs/java/v5/guides/cap-sdk-integration"},"CAP integration")," is used, also the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestContext")," is passed on (requires CDS version ",(0,r.kt)("inlineCode",{parentName:"p"},"1.28")," or higher).")),(0,r.kt)("h3",{id:"configuring-the-executor"},"Configuring the Executor"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextExecutors")," class leverages a single ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextExecutorService")," instance that can be configured."),(0,r.kt)("p",null,"You can create a custom ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContextExecutorService"),", for example to use a different thread pool, via:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"ThreadContextExecutorService executor = DefaultThreadContextExecutorService\n            .of(Executors.newFixedThreadPool(3));\n\n// use it directly:\nexecutor.submit(myTask);\n\n// or set it to be used by the static ThreadContextExecutors API:\nThreadContextExecutors.setExecutor(executor);\nThreadContextExecutors.submit(myTask);\n")),(0,r.kt)("h3",{id:"modifying-the-threadcontext"},"Modifying the ThreadContext"),(0,r.kt)("admonition",{title:"Caution",type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"Modifying the ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext")," as depicted below is currently supported only when using the default ",(0,r.kt)("inlineCode",{parentName:"p"},"Facade")," (e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"DefaultTenantFacade"),") implementations.\nThis is an issue especially when using the CAP integration dependency ",(0,r.kt)("inlineCode",{parentName:"p"},"cds-integration-cloud-sdk"),".\nTo still manipulate the request context, please refer to ",(0,r.kt)("a",{parentName:"p",href:"https://cap.cloud.sap/docs/java/request-contexts#defining-requestcontext"},"the CAP documentation"),".")),(0,r.kt)("p",null,"You may want to run an asynchronous operation in a completely new or custom context.\nBy default, the executor will transfer any existing context to the new thread."),(0,r.kt)("p",null,"To run something in a completely new, empty context, use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"ThreadContextExecutors.submit(myTask, new DefaultThreadContext());\n")),(0,r.kt)("p",null,"By contrast, to pass on the current context, but modifying the tenant (and only the tenant), use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'Tenant myTenant = new DefaultTenant("foo");\nCallable myTaskWithTenant = () -> TenantAccessor.executeWithTenant(myTask, myTenant);\n\nThreadContextExecutors.submit(myTaskWithTenant);\n')),(0,r.kt)("p",null,"To avoid multiple wrappings, in particular when changing multiple values, you can also build a custom executor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'Tenant myTenant = new DefaultTenant("foo");\nPrincipal myPrincipal = new DefaultPrincipal("bar");\n\nThreadContextExecutor customExecutor = ThreadContextExecutor.fromNewContext()\n            .withListeners(\n                new TenantThreadContextListener(myTenant),\n                new PrincipalThreadContextListener(myPrincipal)\n            );\n\nThreadContextExecutors.submit(myTask, customExecutor);\n')),(0,r.kt)("h2",{id:"how-can-the-thread-context-be-used"},"How Can the Thread Context Be Used?"),(0,r.kt)("h3",{id:"accessing-information"},"Accessing Information"),(0,r.kt)("p",null,"The Thread context can be accessed via the static ",(0,r.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/thread/ThreadContextAccessor.html"},(0,r.kt)("inlineCode",{parentName:"a"},"ThreadContextAccessor")),"."),(0,r.kt)("p",null,"For the frequently needed ",(0,r.kt)("em",{parentName:"p"},"HTTP Headers"),", ",(0,r.kt)("em",{parentName:"p"},"Tenant"),", ",(0,r.kt)("em",{parentName:"p"},"Principal"),", and ",(0,r.kt)("em",{parentName:"p"},"JWT")," there are also dedicated accessors:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"RequestHeaderAccessor")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/tenant/TenantAccessor.html"},(0,r.kt)("inlineCode",{parentName:"a"},"TenantAccessor"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/security/principal/PrincipalAccessor.html"},(0,r.kt)("inlineCode",{parentName:"a"},"PrincipalAccessor"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/security/AuthTokenAccessor.html"},(0,r.kt)("inlineCode",{parentName:"a"},"AuthTokenAccessor")))),(0,r.kt)("h3",{id:"storing-information"},"Storing Information"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"pathname:///java-api/v5/com/sap/cloud/sdk/cloudplatform/thread/ThreadContext.html"},(0,r.kt)("inlineCode",{parentName:"a"},"ThreadContext"))," allows for some manipulation by the application.\nHowever, oftentimes it is more convenient to leverage the ",(0,r.kt)("inlineCode",{parentName:"p"},"executeWith...()")," functionality offered by the dedicated accessors."),(0,r.kt)("p",null,"Consider a scenario where some part of the code should run on behalf of a specific tenant.\nIn that case you can override the current tenant explicitly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"TenantAccessor.executeWithTenant(customTenant, () -> doStuff());\n")),(0,r.kt)("admonition",{title:"CAP Integration",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"The above does not apply for accessors like ",(0,r.kt)("inlineCode",{parentName:"p"},"TenantAccessor"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"PrincipalAccessor"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderAccessor")," when using the CAP framework (with the ",(0,r.kt)("inlineCode",{parentName:"p"},"cds-integration-cloud-sdk")," dependency).\nWhen using CAP the Tenant, Principal, and Headers are derived from the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestContext"),".\nPlease refer to ",(0,r.kt)("a",{parentName:"p",href:"https://cap.cloud.sap/docs/java/request-contexts#defining-requestcontext"},"this section")," on how to override existing values in the CAP context.")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Be aware, that the ",(0,r.kt)("inlineCode",{parentName:"p"},"executeWith")," methods shown above only replaces the given property, but does not update properties derived from it."),(0,r.kt)("p",{parentName:"admonition"},"Example: You have a special ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthToken"),", that you propagate with ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthTokenAccessor.executeWithAuthToken"),".\nInside the given code block only the ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthToken")," will be replaced, while e.g. the ",(0,r.kt)("inlineCode",{parentName:"p"},"Tenant")," is the same as in the original context."),(0,r.kt)("p",{parentName:"admonition"},"If you want to start a fresh context based on a given ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthToken"),", for example accessing information of the provider tenant while in a subscriber context, have a look at this code:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"\nTenant retrieveProviderTenant()\n{\n    // retrieves an access token from the provider context\n    AuthToken providerXsuaaAccessToken = new ScpCfAuthTokenFacade().tryGetXsuaaServiceToken().get();\n    ThreadContextExecutor\n        // create a new, empty context\n        .fromNewContext()\n        // add the provider token into the new context\n        .withListeners(new AuthTokenThreadContextListener(providerXsuaaAccessToken))\n        // return the actual provider tenant\n        .execute(TenantAccessor::getCurrentTenant);\n}\n"))),(0,r.kt)("h3",{id:"manipulating-http-headers"},"Manipulating HTTP Headers"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderAccessor#getHeaderContainer()")," method provides convenient access to the HTTP headers of the current incoming request.\nIt returns an instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer"),", which is, by API contract, an ",(0,r.kt)("strong",{parentName:"p"},"immutable")," container that allows ",(0,r.kt)("em",{parentName:"p"},"case insensitive")," access to HTTP header values.\nAlthough the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer")," cannot be altered once created, there are scenarios where manipulating HTTP headers is required.\nIn such cases, a new instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer")," can be created in a few different ways."),(0,r.kt)("h4",{id:"create-a-new-requestheadercontainer-from-scratch"},"Create a new RequestHeaderContainer From Scratch"),(0,r.kt)("p",null,"A common way to represent HTTP headers is to use ",(0,r.kt)("inlineCode",{parentName:"p"},"Map<String, String>")," for ",(0,r.kt)("inlineCode",{parentName:"p"},"1:1")," relationships between header names and values or even ",(0,r.kt)("inlineCode",{parentName:"p"},"Map<String, Collection<String>>")," for ",(0,r.kt)("inlineCode",{parentName:"p"},"1:n")," relationships.\nTo make the transition from either of those representations to the SAP Cloud SDK's ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer")," as easy as possible, the ",(0,r.kt)("inlineCode",{parentName:"p"},"DefaultRequestHeaderContainer")," offers corresponding factory methods:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"fromSingleValueMap(Map<String, String>)")," and"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"fromMultiValueMap(Map<String, ? extends Iterable<String>>)"))),(0,r.kt)("p",null,"The latter one also enables convenient interoperability with the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpHeaders.html"},"Spring Headers"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@RequestMapping( method = RequestMethod.GET )\npublic ResponseEntity<ExampleResponse> getExample( @RequestHeader final HttpHeaders headers)\n{\n  final RequestHeaderContainer container = DefaultRequestHeaderContainer.fromMultiValueMap(headers);\n\n  RequestHeaderAccessor.executeWithHeaderContainer(container, () -> {\n      Tenant tenant = TenantAccessor.getCurrentTenant();\n  });\n}\n")),(0,r.kt)("p",null,"Besides these two factory methods, the ",(0,r.kt)("inlineCode",{parentName:"p"},"DefaultRequestHeaderContainer")," also offers the possibility to create an instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer.Builder")," through the static ",(0,r.kt)("inlineCode",{parentName:"p"},"builder()")," method.\nAn example for how the returned ",(0,r.kt)("inlineCode",{parentName:"p"},"Builder")," can be used is shown in the chapter below."),(0,r.kt)("p",null,"Additionally, to make customizing the current HTTP headers even easier, the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderAccessor")," comes with an overload of the ",(0,r.kt)("inlineCode",{parentName:"p"},"executeWithHeaderContainer")," method that accepts a ",(0,r.kt)("inlineCode",{parentName:"p"},"Map<String, String>"),"."),(0,r.kt)("h4",{id:"updating-an-existing-requestheadercontainer"},"Updating an Existing RequestHeaderContainer"),(0,r.kt)("p",null,"As pointed out above, the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer")," is an ",(0,r.kt)("strong",{parentName:"p"},"immutable")," structure.\nTherefore, updating an already existing instance is impossible."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"However"),", in cases where you would like to, for example, just add a new custom header to the set of existing headers, the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer")," offers the ",(0,r.kt)("inlineCode",{parentName:"p"},"toBuilder")," method.\nAs the name suggests, this method can be used to retrieve an instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer.Builder"),".\nIn contrast to the ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer"),", the ",(0,r.kt)("inlineCode",{parentName:"p"},"Builder")," can be ",(0,r.kt)("strong",{parentName:"p"},"mutated")," as much as needed.\nAdditionally, the ",(0,r.kt)("inlineCode",{parentName:"p"},"toBuilder")," method will make sure that the returned ",(0,r.kt)("inlineCode",{parentName:"p"},"Builder")," instance is already pre-filled with all HTTP headers that are also present in the instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"RequestHeaderContainer"),"."),(0,r.kt)("p",null,"To make things less theoretical, let's examine an example."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Example: Usage of the Builder"),(0,r.kt)("p",null,"Assume your application received an HTTP request that contains the following headers"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Authorization: Bearer DUMMY_JWT")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Set-Cookie: cookie-1; cookie-2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Accept-Language: en-US")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"x-app-specific-header: customer-value"))),(0,r.kt)("p",null,"These values can be accessed as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'RequestHeaderContainer headers = RequestHeaderAccessor.getHeaderContainer();\nheaders.getHeaderValues("authorization"); // will return ["Bearer DUMMY_JWT"]\nheaders.getHeaderValues("set-cookie"); // will return ["cookie-1", "cookie-2"]\nheaders.getHeaderValues("accept-language"); // will return ["en-US"]\nheaders.getHeaderValues("x-app-specific-header"); // will return ["customer-value"]\n')),(0,r.kt)("p",null,"Note how accessing the values for specific HTTP headers will work independent of the casing of the provided name."),(0,r.kt)("p",null,"Now let's say your use case requires that HTTP cookies shall not be leaked into further application execution.\nAdditionally, you have to make sure that the ",(0,r.kt)("inlineCode",{parentName:"p"},"x-app-specific-header")," contains an additional application provided value.\nLastly, our application should always serve German customers and, therefore, you need to make sure the ",(0,r.kt)("inlineCode",{parentName:"p"},"Accept-Language")," header is always adjusted accordingly."),(0,r.kt)("p",null,"Using the ",(0,r.kt)("inlineCode",{parentName:"p"},"Builder")," API, fulfilling these requirements is straightforward:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'RequestHeaderContainer updatedHeaders =\n    headers\n        .toBuilder()\n        .withoutHeader("set-cookie")\n        .withHeader("x-app-specific-header", "application-value")\n        .replaceHeader("accept-language", "de-DE")\n        .build();\n')),(0,r.kt)("p",null,"Once again, the API guarantees that header names are treated ",(0,r.kt)("em",{parentName:"p"},"case insensitively"),"."),(0,r.kt)("p",null,"Finally, to make sure the updated headers are also taken into consideration, you have to overwrite the existing headers in our ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadContext"),".\nThis can be done using the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"RequestHeaderAccessor.executeWithHeaderContainer(updatedHeaders, () -> yourBusinessLogic());\n"))))}c.isMDXComponent=!0}}]);